<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WojThom 4.0 Mobile - Time List</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --bg: #f4f7f6;
            --card: #ffffff;
            --text: #333333;
            --border: #dddddd;
            --shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        body.dark-mode {
            --primary: #1a1a1a;
            --secondary: #2980b9;
            --bg: #121212;
            --card: #1e1e1e;
            --text: #e0e0e0;
            --border: #333;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            padding-bottom: 80px; /* Miejsce na stopk/toast */
            transition: background 0.3s, color 0.3s;
        }

        /* Toolbar / Nawigacja */
        .navbar {
            background: var(--primary);
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .app-title { font-weight: bold; font-size: 1.1rem; }
        
        .menu-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            padding: 5px;
            cursor: pointer;
        }

        /* Menu rozwijane */
        .dropdown-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 998;
        }
        
        .main-menu {
            position: fixed;
            top: 0;
            right: -260px;
            width: 260px;
            height: 100%;
            background: var(--card);
            z-index: 999;
            transition: right 0.3s ease;
            box-shadow: -2px 0 10px rgba(0,0,0,0.2);
            padding-top: 60px;
            overflow-y: auto;
        }

        .main-menu.open { right: 0; }
        .menu-close { position: absolute; top: 15px; right: 15px; font-size: 1.5rem; background:none; border:none; color: var(--text); }

        .menu-item {
            display: block;
            width: 100%;
            padding: 15px 20px;
            text-align: left;
            background: none;
            border: none;
            border-bottom: 1px solid var(--border);
            color: var(--text);
            font-size: 1rem;
        }
        .menu-item i { margin-right: 10px; width: 25px; text-align: center; color: var(--secondary); }
        .menu-header { padding: 10px 20px; font-weight: bold; color: var(--secondary); background: rgba(0,0,0,0.03); }

        /* Kontener g贸wny */
        .container { padding: 15px; max-width: 800px; margin: 0 auto; }

        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        /* Formularze */
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            font-size: 16px; /* Zapobiega zoomowaniu na iPhone */
            margin-bottom: 15px;
        }

        textarea { height: 100px; font-family: monospace; resize: vertical; }

        /* Przyciski G贸wne - Du偶e i wygodne */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .btn-full { width: 100%; }

        .btn {
            border: none;
            border-radius: 8px;
            padding: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }

        .btn-primary { background: var(--secondary); }
        .btn-danger { background: var(--danger); }
        .btn-success { background: var(--success); }
        .btn-neutral { background: #7f8c8d; }

        /* Tabela */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        
        th { background: var(--primary); color: white; padding: 12px; text-align: left; }
        
        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            color: var(--text);
        }

        /* Styl wiersza do klikania */
        tbody tr { cursor: pointer; }
        tbody tr:active { background-color: rgba(52, 152, 219, 0.1); }
        
        /* Bdy */
        tr.error-row { background-color: rgba(231, 76, 60, 0.15); }
        tr.error-row td:first-child { border-left: 4px solid var(--danger); }

        .edit-icon { color: var(--secondary); opacity: 0.5; float: right; }

        /* Podsumowanie */
        .summary-box {
            text-align: right;
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--secondary);
            margin-top: 10px;
            padding: 10px;
            border-top: 2px solid var(--border);
        }

        /* Modale */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            justify-content: center;
            align-items: flex-end; /* Mobile: slide from bottom */
        }
        
        .modal.open { display: flex; }

        .modal-content {
            background: var(--card);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            border-radius: 15px 15px 0 0;
            padding: 20px;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @media (min-width: 768px) {
            .modal { align-items: center; }
            .modal-content { border-radius: 12px; width: 90%; }
        }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 1.2rem; font-weight: bold; }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 3000;
            opacity: 0;
            transition: all 0.3s;
            white-space: nowrap;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* Tabs for Stats */
        .tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 15px; }
        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab.active { border-bottom-color: var(--secondary); font-weight: bold; color: var(--secondary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

    </style>
</head>
<body>

    <nav class="navbar">
        <div class="app-title">WojThom 4.0</div>
        <button class="menu-btn" id="menuToggle"><i class="fas fa-bars"></i></button>
    </nav>

    <div class="dropdown-overlay" id="menuOverlay"></div>
    <div class="main-menu" id="mainMenu">
        <button class="menu-close" id="menuClose">&times;</button>
        
        <div class="menu-header" id="txt_menu_file">Plik</div>
        <button class="menu-item" onclick="openModal('exportModal')"><i class="fas fa-file-pdf"></i> <span id="txt_export">Eksportuj PDF</span></button>
        <button class="menu-item" onclick="toggleTheme()"><i class="fas fa-moon"></i> <span id="txt_theme">Tryb Ciemny</span></button>
        
        <div class="menu-header" id="txt_menu_tools">Narzdzia</div>
        <button class="menu-item" onclick="showStatistics()"><i class="fas fa-chart-pie"></i> <span id="txt_stats">Statystyki</span></button>
        <button class="menu-item" onclick="openModal('filterModal')"><i class="fas fa-filter"></i> <span id="txt_filter">Filtruj</span></button>
        <button class="menu-item" onclick="clearData()"><i class="fas fa-trash"></i> <span id="txt_clear">Wyczy</span></button>
        
        <div class="menu-header" id="txt_menu_lang">Jzyk</div>
        <button class="menu-item" onclick="setLanguage('no')">仇 Norsk</button>
        <button class="menu-item" onclick="setLanguage('pl')">叼 Polski</button>
        <button class="menu-item" onclick="setLanguage('en')"> English</button>
    </div>

    <div class="container">
        
        <div class="card">
            <label for="headerInput" id="lbl_header">Nag贸wek listy:</label>
            <input type="text" id="headerInput" value="Tidsliste">
            
            <label for="rawInput" id="lbl_input">Wklej dane (Data Klient Czas):</label>
            <textarea id="rawInput" placeholder="np. 12.05 Firma ABC 08:00-16:00"></textarea>
            
            <button class="btn btn-primary btn-full" onclick="processData()">
                <i class="fas fa-play"></i> <span id="btn_generate">Generuj List</span>
            </button>
        </div>

        <div class="card" id="resultCard" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0; font-size:1.1rem; color:var(--secondary);" id="lbl_result">Wynik:</h3>
                <small style="color:var(--text); opacity:0.7;">(Kliknij wiersz aby edytowa)</small>
            </div>

            <div class="table-container">
                <table id="resultTable">
                    <thead>
                        <tr>
                            <th id="th_date">Data</th>
                            <th id="th_client">Klient</th>
                            <th id="th_hours">Godziny</th>
                            <th id="th_time">Czas</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            
            <div class="summary-box" id="summaryBox">Suma: 0:00</div>
            
            <div style="margin-top:15px;">
                <button class="btn btn-danger btn-full" onclick="openModal('exportModal')">
                    <i class="fas fa-file-pdf"></i> <span id="btn_export_bottom">Pobierz PDF</span>
                </button>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="modal_edit_title">Edytuj Wpis</span>
                <span onclick="closeModal('editModal')" style="cursor:pointer">&times;</span>
            </div>
            <input type="hidden" id="editIndex">
            
            <label id="lbl_edit_date">Data</label>
            <input type="text" id="editDate">
            
            <label id="lbl_edit_client">Klient</label>
            <input type="text" id="editClient">
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div>
                    <label id="lbl_edit_start">Start</label>
                    <input type="text" id="editStart">
                </div>
                <div>
                    <label id="lbl_edit_end">Koniec</label>
                    <input type="text" id="editEnd">
                </div>
            </div>
            
            <label id="lbl_edit_work">Czas pracy (opcjonalnie)</label>
            <input type="text" id="editWork">

            <div class="btn-group">
                <button class="btn btn-neutral" onclick="closeModal('editModal')" id="btn_cancel">Anuluj</button>
                <button class="btn btn-success" onclick="saveEdit()" id="btn_save">Zapisz</button>
            </div>
            <button class="btn btn-danger btn-full" onclick="deleteEntry()" style="margin-top:10px;" id="btn_delete">Usu wiersz</button>
        </div>
    </div>

    <div id="filterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="modal_filter_title">Filtrowanie</span>
                <span onclick="closeModal('filterModal')" style="cursor:pointer">&times;</span>
            </div>
            <label id="lbl_filter_client">Klient:</label>
            <select id="filterClient"><option value="">Wszyscy</option></select>
            
            <div class="btn-group" style="margin-top:20px;">
                <button class="btn btn-neutral" onclick="resetFilter()" id="btn_reset">Reset</button>
                <button class="btn btn-primary" onclick="applyFilter()" id="btn_apply">Filtruj</button>
            </div>
        </div>
    </div>

    <div id="statsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="modal_stats_title">Statystyki</span>
                <span onclick="closeModal('statsModal')" style="cursor:pointer">&times;</span>
            </div>
            
            <div class="tabs">
                <div class="tab active" onclick="switchTab('timeChartTab')" id="tab_date">Wg Daty</div>
                <div class="tab" onclick="switchTab('clientChartTab')" id="tab_client">Wg Klienta</div>
            </div>
            
            <div id="timeChartTab" class="tab-content active" style="height:300px; position:relative;">
                <canvas id="timeChartCanvas"></canvas>
            </div>
            <div id="clientChartTab" class="tab-content" style="height:300px; position:relative;">
                <canvas id="clientChartCanvas"></canvas>
            </div>
            
            <button class="btn btn-neutral btn-full" onclick="closeModal('statsModal')" style="margin-top:15px;">Zamknij</button>
        </div>
    </div>

    <div id="exportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="modal_export_title">Wybierz jzyk PDF</span>
                <span onclick="closeModal('exportModal')" style="cursor:pointer">&times;</span>
            </div>
            <p id="lbl_export_desc">W jakim jzyku wygenerowa dokument?</p>
            <button class="btn btn-primary btn-full" onclick="generatePDF('no')" style="margin-bottom:10px;">仇 Norsk</button>
            <button class="btn btn-primary btn-full" onclick="generatePDF('pl')" style="margin-bottom:10px;">叼 Polski</button>
            <button class="btn btn-primary btn-full" onclick="generatePDF('en')"> English</button>
        </div>
    </div>

    <div id="toast" class="toast">Powiadomienie</div>

    <script>
        // --- Konfiguracja i Jzyki ---
        const translations = {
            pl: {
                header: "Nag贸wek:", input: "Dane wejciowe:", generate: "Generuj", result: "Wynik:",
                date: "Data", client: "Klient", hours: "Godz. pracy", time: "Czas",
                sum: "Suma cakowita", file: "Plik", tools: "Narzdzia", lang: "Jzyk",
                export: "Eksportuj PDF", theme: "Tryb Ciemny", stats: "Statystyki", filter: "Filtruj", clear: "Wyczy",
                edit_title: "Edycja", save: "Zapisz", cancel: "Anuluj", delete: "Usu",
                toast_gen: "Wygenerowano list!", toast_save: "Zapisano zmiany", toast_err: "Sprawd藕 bdy (czerwone)",
                filter_title: "Filtruj", filter_client: "Wybierz klienta", reset: "Resetuj", apply: "Zastosuj",
                export_title: "Eksport PDF", export_desc: "Wybierz jzyk dokumentu:",
                tab_date: "Wg Daty", tab_client: "Wg Klienta"
            },
            no: {
                header: "Overskrift:", input: "Lim inn data:", generate: "Generer", result: "Resultat:",
                date: "Dato", client: "Kunde", hours: "Tidspunkt", time: "Tid",
                sum: "Sum totalt", file: "Fil", tools: "Verkt酶y", lang: "Spr氓k",
                export: "Eksporter PDF", theme: "M酶rk modus", stats: "Statistikk", filter: "Filter", clear: "T酶m",
                edit_title: "Rediger", save: "Lagre", cancel: "Avbryt", delete: "Slett",
                toast_gen: "Liste generert!", toast_save: "Lagret", toast_err: "Sjekk feil (r酶d)",
                filter_title: "Filter", filter_client: "Velg kunde", reset: "Tilbakestill", apply: "Bruk",
                export_title: "Eksport PDF", export_desc: "Velg dokumentspr氓k:",
                tab_date: "Etter Dato", tab_client: "Etter Kunde"
            },
            en: {
                header: "Header:", input: "Paste data:", generate: "Generate", result: "Result:",
                date: "Date", client: "Client", hours: "Hours", time: "Time",
                sum: "Total Sum", file: "File", tools: "Tools", lang: "Language",
                export: "Export PDF", theme: "Dark Mode", stats: "Statistics", filter: "Filter", clear: "Clear",
                edit_title: "Edit", save: "Save", cancel: "Cancel", delete: "Delete",
                toast_gen: "List generated!", toast_save: "Saved", toast_err: "Check errors (red)",
                filter_title: "Filter", filter_client: "Select client", reset: "Reset", apply: "Apply",
                export_title: "Export PDF", export_desc: "Select document language:",
                tab_date: "By Date", tab_client: "By Client"
            }
        };

        let currentLang = localStorage.getItem('wt_lang') || 'pl';
        let entries = [];
        let originalEntries = null; // Do filtrowania
        let charts = {};

        // --- Inicjalizacja ---
        document.addEventListener('DOMContentLoaded', () => {
            loadFromStorage();
            applyLanguage(currentLang);
            if(document.getElementById('rawInput').value.trim()) processData();
            
            // Obsuga Menu
            document.getElementById('menuToggle').onclick = () => {
                document.getElementById('mainMenu').classList.add('open');
                document.getElementById('menuOverlay').style.display = 'block';
            };
            
            const closeMenu = () => {
                document.getElementById('mainMenu').classList.remove('open');
                document.getElementById('menuOverlay').style.display = 'none';
            };
            
            document.getElementById('menuClose').onclick = closeMenu;
            document.getElementById('menuOverlay').onclick = closeMenu;
            
            // Auto-save input
            document.getElementById('rawInput').addEventListener('input', () => {
                localStorage.setItem('wt_input', document.getElementById('rawInput').value);
            });
            document.getElementById('headerInput').addEventListener('input', () => {
                localStorage.setItem('wt_header', document.getElementById('headerInput').value);
            });
        });

        function loadFromStorage() {
            const savedInput = localStorage.getItem('wt_input');
            const savedHeader = localStorage.getItem('wt_header');
            const savedTheme = localStorage.getItem('wt_theme');
            
            if(savedInput) document.getElementById('rawInput').value = savedInput;
            if(savedHeader) document.getElementById('headerInput').value = savedHeader;
            if(savedTheme === 'dark') document.body.classList.add('dark-mode');
        }

        // --- Logika Biznesowa ---
        function parseTime(str) {
            if(!str) return 0;
            str = str.replace(/[.,]/g, ':').replace(/[ht\s]/gi, ''); // clean
            let parts = str.split(':');
            let m = 0;
            if (parts.length === 2) {
                m = parseInt(parts[0])*60 + parseInt(parts[1]);
            } else if (parts.length === 1 && !isNaN(parseFloat(parts[0]))) {
                // decimal hours ex. 1.5
                m = Math.round(parseFloat(parts[0]) * 60);
            }
            return isNaN(m) ? 0 : m;
        }

        function minsToStr(mins) {
            let h = Math.floor(mins / 60);
            let m = mins % 60;
            return `${h}:${m.toString().padStart(2,'0')}`;
        }

        function processData() {
            const raw = document.getElementById('rawInput').value;
            const lines = raw.split('\n');
            entries = [];
            let hasError = false;

            lines.forEach(line => {
                if(!line.trim()) return;
                
                let entry = {
                    original: line,
                    date: '', client: '', start: '', end: '', workStr: '', mins: 0,
                    error: false
                };

                // Regex do parsowania
                // 1. Data (DD.MM lub DD-MM)
                let dateMatch = line.match(/^(\d{1,2}[.,/-]\d{1,2})/);
                let rest = line;
                
                if(dateMatch) {
                    entry.date = dateMatch[1].replace(/[.,/]/, '-');
                    rest = line.substring(dateMatch[0].length).trim();
                } else {
                    entry.error = true;
                    entry.client = line; // Caa linia jako klient jeli brak daty
                }

                // 2. Czas (HH:MM-HH:MM lub Xh)
                let rangeMatch = rest.match(/(\d{1,2}[:.]\d{2})\s*[-]\s*(\d{1,2}[:.]\d{2})/);
                let durMatch = rest.match(/(\d+([.,]\d+)?)\s*[ht](?!\w)/i) || rest.match(/\s(\d+([.,]\d+)?)$/);

                if(rangeMatch) {
                    entry.start = rangeMatch[1].replace('.',':');
                    entry.end = rangeMatch[2].replace('.',':');
                    let startM = parseTime(entry.start);
                    let endM = parseTime(entry.end);
                    entry.mins = endM - startM;
                    entry.workStr = minsToStr(entry.mins);
                    // Klient to co jest przed czasem
                    entry.client = rest.substring(0, rangeMatch.index).trim();
                } else if (durMatch) {
                    entry.workStr = durMatch[1];
                    entry.mins = parseTime(durMatch[1]);
                    entry.client = rest.substring(0, durMatch.index).trim();
                } else {
                    if(!entry.error) entry.error = true; // Brak czasu
                    entry.client = rest;
                }

                if(!entry.client) entry.client = "?";
                if(entry.mins <= 0 && !entry.error) { entry.error = true; entry.mins = 0; }

                entries.push(entry);
                if(entry.error) hasError = true;
            });

            originalEntries = [...entries]; // Kopia do filtra
            renderTable();
            document.getElementById('resultCard').style.display = 'block';
            
            if(hasError) showToast(translations[currentLang].toast_err, true);
            else showToast(translations[currentLang].toast_gen);
            
            // Scroll to result on mobile
            if(window.innerWidth < 768) {
                document.getElementById('resultCard').scrollIntoView({behavior: 'smooth'});
            }
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            let totalMins = 0;

            entries.forEach((e, idx) => {
                let tr = document.createElement('tr');
                if(e.error) tr.className = 'error-row';
                tr.onclick = () => openEdit(idx);
                
                // Dla mobile: dodaj ikonk o贸wka w ostatniej kolumnie lub przy kliencie
                tr.innerHTML = `
                    <td>${e.date}</td>
                    <td>
                        <div style="font-weight:500">${e.client}</div>
                        ${window.innerWidth < 600 ? `<small style="opacity:0.7">${e.start ? e.start + '-' + e.end : ''}</small>` : ''}
                    </td>
                    ${window.innerWidth >= 600 ? `<td>${e.start} - ${e.end}</td>` : ''} <td>
                        <strong>${e.workStr}</strong>
                        <i class="fas fa-pen edit-icon"></i>
                    </td>
                `;
                
                if(!e.error) totalMins += e.mins;
                tbody.appendChild(tr);
            });

            document.getElementById('summaryBox').innerText = `${translations[currentLang].sum}: ${minsToStr(totalMins)}`;
        }

        // --- Edycja ---
        function openEdit(idx) {
            // Jeli jest filtrowanie, musimy znale藕 oryginalny indeks, ale upromy:
            // Edycja dziaa na aktualnie wywietlanej tablicy 'entries'.
            // Jeli filtrowanie jest aktywne, edycja zmienia tylko widok? Nie, powinno zmienia orygina.
            // Dla uproszczenia w wersji 4.0: Edycja dziaa na 'entries'. 
            // Przy resecie filtra zmiany mog zosta nadpisane jeli nie zsynchronizujemy.
            // Szybki fix: Edytujemy obiekt referencyjny.
            
            let e = entries[idx];
            document.getElementById('editIndex').value = idx;
            document.getElementById('editDate').value = e.date;
            document.getElementById('editClient').value = e.client;
            document.getElementById('editStart').value = e.start;
            document.getElementById('editEnd').value = e.end;
            document.getElementById('editWork').value = e.mins > 0 ? e.workStr : '';
            
            openModal('editModal');
        }

        function saveEdit() {
            let idx = document.getElementById('editIndex').value;
            let e = entries[idx];
            
            e.date = document.getElementById('editDate').value;
            e.client = document.getElementById('editClient').value;
            e.start = document.getElementById('editStart').value;
            e.end = document.getElementById('editEnd').value;
            
            let manualWork = document.getElementById('editWork').value;
            
            // Przelicz
            if(e.start && e.end) {
                let s = parseTime(e.start);
                let end = parseTime(e.end);
                e.mins = end - s;
                e.workStr = minsToStr(e.mins);
                e.error = false;
            } else if (manualWork) {
                e.mins = parseTime(manualWork);
                e.workStr = minsToStr(e.mins);
                e.error = false;
            }
            
            if(e.mins <= 0) e.error = true;

            renderTable();
            closeModal('editModal');
            showToast(translations[currentLang].toast_save);
        }

        function deleteEntry() {
            let idx = document.getElementById('editIndex').value;
            entries.splice(idx, 1);
            // Synchronize original if filtered? (Advanced feature omitted for stability)
            if(originalEntries) {
                 // Simple approach: reset filter data to match
                 originalEntries = [...entries];
            }
            renderTable();
            closeModal('editModal');
        }

        // --- Funkcje Pomocnicze UI ---
        function openModal(id) {
            document.getElementById(id).classList.add('open');
            // Zamykanie menu jeli otwarte
            document.getElementById('mainMenu').classList.remove('open');
            document.getElementById('menuOverlay').style.display = 'none';
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('open');
        }
        
        // Zamykanie modali klikajc w to
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('open');
            }
        }

        function showToast(msg, isError = false) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.background = isError ? 'var(--danger)' : '#333';
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            let theme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
            localStorage.setItem('wt_theme', theme);
            // Close menu
            document.getElementById('mainMenu').classList.remove('open');
            document.getElementById('menuOverlay').style.display = 'none';
        }

        function clearData() {
            if(confirm('Na pewno wyczyci wszystko?')) {
                document.getElementById('rawInput').value = '';
                localStorage.setItem('wt_input', '');
                document.getElementById('resultCard').style.display = 'none';
                entries = [];
                document.getElementById('mainMenu').classList.remove('open');
                document.getElementById('menuOverlay').style.display = 'none';
            }
        }

        // --- Tumaczenia ---
        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('wt_lang', lang);
            applyLanguage(lang);
            // Re-render table to update headers/sum
            if(entries.length > 0) renderTable();
            document.getElementById('mainMenu').classList.remove('open');
            document.getElementById('menuOverlay').style.display = 'none';
        }

        function applyLanguage(lang) {
            const t = translations[lang];
            // Mapowanie ID do tekst贸w
            const ids = {
                'lbl_header': t.header, 'lbl_input': t.input, 'btn_generate': t.generate, 'lbl_result': t.result,
                'th_date': t.date, 'th_client': t.client, 'th_hours': t.hours, 'th_time': t.time,
                'txt_menu_file': t.file, 'txt_menu_tools': t.tools, 'txt_menu_lang': t.lang,
                'txt_export': t.export, 'txt_theme': t.theme, 'txt_stats': t.stats, 'txt_filter': t.filter, 'txt_clear': t.clear,
                'modal_edit_title': t.edit_title, 'btn_save': t.save, 'btn_cancel': t.cancel, 'btn_delete': t.delete,
                'modal_filter_title': t.filter_title, 'lbl_filter_client': t.filter_client, 'btn_reset': t.reset, 'btn_apply': t.apply,
                'modal_export_title': t.export_title, 'lbl_export_desc': t.export_desc, 'btn_export_bottom': t.export,
                'tab_date': t.tab_date, 'tab_client': t.tab_client,
                'lbl_edit_date': t.date, 'lbl_edit_client': t.client, 'lbl_edit_start': t.hours, 'lbl_edit_end': t.hours, 'lbl_edit_work': t.time
            };

            for(let id in ids) {
                let el = document.getElementById(id);
                if(el) el.innerText = ids[id];
            }
        }

        // --- Filtrowanie ---
        function resetFilter() {
            if(originalEntries) entries = [...originalEntries];
            renderTable();
            closeModal('filterModal');
        }

        function applyFilter() {
            const clientVal = document.getElementById('filterClient').value;
            if(originalEntries && clientVal) {
                entries = originalEntries.filter(e => e.client === clientVal);
            } else if (originalEntries) {
                entries = [...originalEntries];
            }
            renderTable();
            closeModal('filterModal');
        }
        
        // Populate filter dropdown on modal open
        document.querySelector('[onclick="openModal(\'filterModal\')"]').addEventListener('click', () => {
            const sel = document.getElementById('filterClient');
            sel.innerHTML = `<option value="">${translations[currentLang].reset}</option>`;
            const clients = [...new Set(entries.map(e => e.client))].sort();
            clients.forEach(c => {
                let opt = document.createElement('option');
                opt.value = c;
                opt.innerText = c;
                sel.appendChild(opt);
            });
        });

        // --- Statystyki ---
        function showStatistics() {
            if(entries.length === 0) return alert('Brak danych');
            openModal('statsModal');
            
            // Prepare Data
            const byDate = {};
            const byClient = {};
            
            entries.forEach(e => {
                if(e.mins <= 0) return;
                let h = e.mins / 60;
                byDate[e.date] = (byDate[e.date] || 0) + h;
                byClient[e.client] = (byClient[e.client] || 0) + h;
            });
            
            renderChart('timeChartCanvas', Object.keys(byDate), Object.values(byDate), 'bar', '#3498db');
            renderChart('clientChartCanvas', Object.keys(byClient), Object.values(byClient), 'pie', ['#2ecc71', '#3498db', '#9b59b6', '#f1c40f', '#e74c3c']);
        }
        
        function renderChart(canvasId, labels, data, type, color) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if(charts[canvasId]) charts[canvasId].destroy();
            
            charts[canvasId] = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Godziny',
                        data: data,
                        backgroundColor: color,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: type === 'pie' } }
                }
            });
        }
        
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if(tabId === 'timeChartTab') document.getElementById('tab_date').classList.add('active');
            else document.getElementById('tab_client').classList.add('active');
        }

        // --- PDF Export ---
        function generatePDF(langCode) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const t = translations[langCode];
            
            const title = document.getElementById('headerInput').value;
            
            doc.setFontSize(18);
            doc.text(title, 14, 20);
            
            doc.setFontSize(10);
            doc.text(`${t.date}: ${new Date().toLocaleDateString()}`, 14, 28);
            
            let tableData = entries.map(e => [e.date, e.client, e.start ? `${e.start}-${e.end}` : '-', e.workStr]);
            
            // Add Sum row
            let totalMins = entries.reduce((acc, e) => acc + e.mins, 0);
            tableData.push(['', '', t.sum, minsToStr(totalMins)]);

            doc.autoTable({
                startY: 35,
                head: [[t.date, t.client, t.hours, t.time]],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: [44, 62, 80] },
                styles: { fontSize: 10 },
                columnStyles: { 
                    0: { cellWidth: 25 }, 
                    1: { cellWidth: 'auto' },
                    2: { cellWidth: 30 },
                    3: { cellWidth: 25, fontStyle: 'bold' }
                },
                didParseCell: function(data) {
                    // Bold sum row
                    if (data.row.index === tableData.length - 1) {
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.fillColor = [220, 220, 220];
                    }
                }
            });
            
            doc.save('TimeList.pdf');
            closeModal('exportModal');
        }

    </script>
</body>
</html>
