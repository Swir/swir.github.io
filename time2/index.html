<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WojThom 6.0 - Time Report</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --highlight: #2980b9;
            --bg: #f4f6f8;
            --card: #ffffff;
            --text: #2c3e50;
            --border: #dfe6e9;
            --danger: #c0392b;
            --success: #27ae60;
        }

        body.dark-mode {
            --primary: #ecf0f1;
            --secondary: #bdc3c7;
            --highlight: #3498db;
            --bg: #121212;
            --card: #1e1e1e;
            --text: #ecf0f1;
            --border: #333;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            padding-bottom: 50px;
            transition: background 0.3s, color 0.3s;
        }

        /* Top Navigation */
        .navbar {
            background: #ffffff;
            color: var(--primary);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-bottom: 1px solid var(--border);
        }
        body.dark-mode .navbar { background: #1e1e1e; border-bottom: 1px solid #333; }

        .app-title { font-weight: 700; font-size: 1.1rem; letter-spacing: 0.5px; color: var(--highlight); }
        .menu-btn { background: none; border: none; color: var(--text); font-size: 1.4rem; padding: 5px; cursor: pointer; }

        /* Side Menu */
        .dropdown-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 998; backdrop-filter: blur(2px); }
        .main-menu {
            position: fixed; top: 0; right: -280px; width: 280px; height: 100%;
            background: var(--card); z-index: 999; transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: -5px 0 15px rgba(0,0,0,0.1); padding-top: 60px;
        }
        .main-menu.open { right: 0; }
        .menu-close { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; background:none; border:none; color: var(--text); cursor: pointer; }

        .menu-item {
            display: flex; align-items: center; width: 100%; padding: 15px 25px;
            text-align: left; background: none; border: none; border-bottom: 1px solid var(--border);
            color: var(--text); font-size: 0.95rem; cursor: pointer;
        }
        .menu-item:active { background: rgba(0,0,0,0.05); }
        .menu-item i { margin-right: 15px; width: 20px; text-align: center; color: var(--highlight); opacity: 0.8; }
        .menu-header { padding: 15px 25px 5px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; color: var(--secondary); letter-spacing: 1px; margin-top: 10px; opacity: 0.7; }

        /* Main Container */
        .container { padding: 20px; max-width: 800px; margin: 0 auto; }
        
        .card {
            background: var(--card); border-radius: 12px; padding: 25px;
            margin-bottom: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.03); border: 1px solid var(--border);
        }

        /* Inputs */
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.85rem; color: var(--secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        input, textarea, select {
            width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px;
            background: var(--bg); color: var(--text); font-size: 16px; margin-bottom: 20px;
            font-family: inherit; transition: border-color 0.2s;
        }
        input:focus, textarea:focus { border-color: var(--highlight); }
        textarea { height: 120px; font-family: 'Monaco', 'Consolas', monospace; line-height: 1.5; resize: vertical; }

        /* Buttons */
        .btn {
            border: none; border-radius: 8px; padding: 14px; font-size: 0.95rem; font-weight: 600;
            cursor: pointer; color: white; display: flex; align-items: center; justify-content: center;
            gap: 10px; transition: opacity 0.2s; width: 100%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn:active { transform: translateY(1px); box-shadow: none; }
        .btn-primary { background: var(--highlight); }
        .btn-danger { background: var(--danger); }
        .btn-neutral { background: #95a5a6; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }

        /* Table */
        .table-container { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; color: var(--secondary); padding: 12px 15px; text-align: left; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; border-bottom: 2px solid var(--border); white-space: nowrap; }
        body.dark-mode th { background: #2c2c2c; }
        
        td { padding: 14px 15px; border-bottom: 1px solid var(--border); color: var(--text); font-size: 0.95rem; vertical-align: middle; }
        
        /* Row Styling */
        tbody tr:last-child td { border-bottom: none; }
        tbody tr { cursor: pointer; transition: background 0.1s; }
        tbody tr:hover { background-color: rgba(0,0,0,0.02); }
        
        tr.error-row { background-color: rgba(192, 57, 43, 0.08); }
        tr.error-row td:first-child { border-left: 4px solid var(--danger); }

        .client-col { font-weight: 500; }
        .time-col { font-family: 'Monaco', monospace; font-weight: 600; text-align: right; color: var(--highlight); }

        /* Summary */
        .summary-row {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 20px; padding-top: 20px; border-top: 1px dashed var(--border);
        }
        .summary-label { font-size: 0.9rem; color: var(--secondary); font-weight: 600; text-transform: uppercase; }
        .summary-value { font-size: 1.5rem; color: var(--text); font-weight: 700; font-family: 'Monaco', monospace; }

        /* Modals */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: flex-end;
            backdrop-filter: blur(2px);
        }
        .modal.open { display: flex; }
        .modal-content {
            background: var(--card); width: 100%; max-width: 600px;
            border-radius: 20px 20px 0 0; padding: 30px;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @media (min-width: 768px) { .modal { align-items: center; } .modal-content { border-radius: 12px; width: 90%; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-size: 1.2rem; font-weight: 700; }

        /* Toast */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: #333; color: white; padding: 12px 24px; border-radius: 50px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 3000; opacity: 0; transition: all 0.4s;
            font-weight: 500; font-size: 0.9rem; display: flex; align-items: center; gap: 8px;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="app-title">WojThom 6.0</div>
        <button class="menu-btn" id="menuToggle"><i class="fas fa-bars"></i></button>
    </nav>

    <div class="dropdown-overlay" id="menuOverlay"></div>
    <div class="main-menu" id="mainMenu">
        <button class="menu-close" id="menuClose">&times;</button>
        
        <div class="menu-header" id="txt_menu_file">File</div>
        <button class="menu-item" onclick="openModal('exportModal')"><i class="fas fa-file-pdf"></i> <span id="txt_export">Export PDF</span></button>
        <button class="menu-item" onclick="clearData()"><i class="fas fa-trash"></i> <span id="txt_clear">Clear Data</span></button>
        
        <div class="menu-header" id="txt_menu_tools">Tools</div>
        <button class="menu-item" onclick="showStatistics()"><i class="fas fa-chart-pie"></i> <span id="txt_stats">Statistics</span></button>
        <button class="menu-item" onclick="openModal('filterModal')"><i class="fas fa-filter"></i> <span id="txt_filter">Filter</span></button>
        
        <div class="menu-header" id="txt_menu_settings">Settings</div>
        <button class="menu-item" onclick="toggleTheme()"><i class="fas fa-adjust"></i> <span id="txt_theme">Dark Mode</span></button>
        <button class="menu-item" onclick="setLanguage('en')">ðŸ‡¬ðŸ‡§ English</button>
        <button class="menu-item" onclick="setLanguage('no')">ðŸ‡³ðŸ‡´ Norsk</button>
        <button class="menu-item" onclick="setLanguage('pl')">ðŸ‡µðŸ‡± Polski</button>
    </div>

    <div class="container">
        
        <div class="card">
            <label for="headerInput" id="lbl_header">Report Title</label>
            <input type="text" id="headerInput" value="Time Report">
            
            <label for="rawInput" id="lbl_input">Paste Data (Date | Client | Hours)</label>
            <textarea id="rawInput" placeholder="Examples:&#10;12.05 Client A 08:00-16:00&#10;13.05 Client B 0.75&#10;14.05 Client C 8h"></textarea>
            
            <button class="btn btn-primary" onclick="processData()">
                <i class="fas fa-check"></i> <span id="btn_generate">Generate List</span>
            </button>
        </div>

        <div class="card" id="resultCard" style="display:none;">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <label id="lbl_result">Result</label>
            </div>

            <div class="table-container">
                <table id="resultTable">
                    <thead>
                        <tr>
                            <th id="th_date">Date</th>
                            <th id="th_client">Client / Note</th>
                            <th id="th_time" style="text-align:right">Time Entered</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            
            <div class="summary-row">
                <div class="summary-label" id="lbl_total">Total Hours</div>
                <div class="summary-value" id="summaryValue">0:00</div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-danger" onclick="openModal('exportModal')">
                    <i class="fas fa-file-pdf"></i> PDF
                </button>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="modal_edit_title">Edit Entry</span>
                <span onclick="closeModal('editModal')" style="cursor:pointer">&times;</span>
            </div>
            <input type="hidden" id="editIndex">
            
            <label id="lbl_edit_date">Date</label>
            <input type="text" id="editDate">
            
            <label id="lbl_edit_client">Client</label>
            <input type="text" id="editClient">
            
            <label id="lbl_edit_display">Display Time (Exact text on PDF)</label>
            <input type="text" id="editDisplayTime" placeholder="e.g. 0.75 or 08:00-16:00">
            <small style="color:#7f8c8d; display:block; margin-top:-15px; margin-bottom:15px;">The system calculates math from this automatically.</small>

            <div class="btn-group">
                <button class="btn btn-neutral" onclick="closeModal('editModal')" id="btn_cancel">Cancel</button>
                <button class="btn btn-primary" onclick="saveEdit()" id="btn_save">Save</button>
            </div>
            <button class="btn btn-danger" onclick="deleteEntry()" style="margin-top:15px;" id="btn_delete">Delete</button>
        </div>
    </div>

    <div id="exportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="modal_export_title">Select Language</span>
                <span onclick="closeModal('exportModal')" style="cursor:pointer">&times;</span>
            </div>
            <button class="btn btn-primary" onclick="generatePDF('en')" style="margin-bottom:10px;">ðŸ‡¬ðŸ‡§ English</button>
            <button class="btn btn-primary" onclick="generatePDF('no')" style="margin-bottom:10px;">ðŸ‡³ðŸ‡´ Norsk</button>
            <button class="btn btn-primary" onclick="generatePDF('pl')">ðŸ‡µðŸ‡± Polski</button>
        </div>
    </div>

    <div id="filterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="modal_filter_title">Filter</span>
                <span onclick="closeModal('filterModal')" style="cursor:pointer">&times;</span>
            </div>
            <select id="filterClient"><option value="">All Clients</option></select>
            <div class="btn-group">
                <button class="btn btn-neutral" onclick="resetFilter()" id="btn_reset">Reset</button>
                <button class="btn btn-primary" onclick="applyFilter()" id="btn_apply">Apply</button>
            </div>
        </div>
    </div>
    
    <div id="statsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="txt_stats_title">Statistics</span>
                <span onclick="closeModal('statsModal')" style="cursor:pointer">&times;</span>
            </div>
            <div style="height:300px;"><canvas id="chartCanvas"></canvas></div>
            <button class="btn btn-neutral" onclick="closeModal('statsModal')" style="margin-top:20px;">Close</button>
        </div>
    </div>

    <div id="toast" class="toast">Message</div>

    <script>
        // --- DATA & CONFIG ---
        const translations = {
            en: {
                header: "Report Title", input: "Paste Data (Date | Client | Hours)", generate: "Generate List",
                result: "Result", date: "Date", client: "Client / Note", time: "Time Entered", total: "Total Hours",
                file: "File", tools: "Tools", settings: "Settings", export: "Export PDF", clear: "Clear Data",
                stats: "Statistics", filter: "Filter", theme: "Dark Mode",
                edit_title: "Edit Entry", display_time: "Display Time (Exact text)", 
                save: "Save", cancel: "Cancel", delete: "Delete",
                export_title: "Select Language", filter_title: "Filter", reset: "Reset", apply: "Apply",
                toast_gen: "List generated!", toast_err: "Check red highlighted rows",
                pdf_gen: "Generated on", pdf_page: "Page", sum: "Total"
            },
            pl: {
                header: "TytuÅ‚ Raportu", input: "Wklej Dane (Data | Klient | Godziny)", generate: "Generuj ListÄ™",
                result: "Wynik", date: "Data", client: "Klient / Opis", time: "Wpisany Czas", total: "Suma Godzin",
                file: "Plik", tools: "NarzÄ™dzia", settings: "Ustawienia", export: "Eksport PDF", clear: "WyczyÅ›Ä‡",
                stats: "Statystyki", filter: "Filtruj", theme: "Tryb Ciemny",
                edit_title: "Edycja Wpisu", display_time: "WyÅ›wietlany Czas (DokÅ‚adny tekst)", 
                save: "Zapisz", cancel: "Anuluj", delete: "UsuÅ„",
                export_title: "Wybierz JÄ™zyk", filter_title: "Filtrowanie", reset: "Reset", apply: "Zastosuj",
                toast_gen: "Lista wygenerowana!", toast_err: "SprawdÅº bÅ‚Ä™dy (na czerwono)",
                pdf_gen: "Wygenerowano", pdf_page: "Strona", sum: "Razem"
            },
            no: {
                header: "Rapporttittel", input: "Lim inn data (Dato | Kunde | Timer)", generate: "Generer Liste",
                result: "Resultat", date: "Dato", client: "Kunde / Notat", time: "Tid Skrevet", total: "Totalt Timer",
                file: "Fil", tools: "VerktÃ¸y", settings: "Innstillinger", export: "Eksport PDF", clear: "TÃ¸m Data",
                stats: "Statistikk", filter: "Filter", theme: "MÃ¸rk Modus",
                edit_title: "Rediger OppfÃ¸ring", display_time: "Vist Tid (Eksakt tekst)", 
                save: "Lagre", cancel: "Avbryt", delete: "Slett",
                export_title: "Velg SprÃ¥k", filter_title: "Filter", reset: "Tilbakestill", apply: "Bruk",
                toast_gen: "Liste generert!", toast_err: "Sjekk rÃ¸de feil",
                pdf_gen: "Generert", pdf_page: "Side", sum: "Totalt"
            }
        };

        let currentLang = localStorage.getItem('wt6_lang') || 'en';
        let entries = [];
        let originalEntries = null;
        let myChart = null;

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            loadStorage();
            setLanguage(currentLang);
            if(document.getElementById('rawInput').value.trim()) processData();

            document.getElementById('menuToggle').onclick = () => {
                document.getElementById('mainMenu').classList.add('open');
                document.getElementById('menuOverlay').style.display = 'block';
            };
            const closeMenu = () => {
                document.getElementById('mainMenu').classList.remove('open');
                document.getElementById('menuOverlay').style.display = 'none';
            };
            document.getElementById('menuClose').onclick = closeMenu;
            document.getElementById('menuOverlay').onclick = closeMenu;

            ['rawInput', 'headerInput'].forEach(id => {
                document.getElementById(id).addEventListener('input', () => {
                    localStorage.setItem('wt6_' + id, document.getElementById(id).value);
                });
            });
        });

        function loadStorage() {
            const savedInput = localStorage.getItem('wt6_rawInput');
            const savedHeader = localStorage.getItem('wt6_headerInput');
            const savedTheme = localStorage.getItem('wt6_theme');
            if(savedInput) document.getElementById('rawInput').value = savedInput;
            if(savedHeader) document.getElementById('headerInput').value = savedHeader;
            if(savedTheme === 'dark') document.body.classList.add('dark-mode');
        }

        // --- CORE LOGIC ---
        function calculateMinutes(str) {
            if(!str) return 0;
            str = str.trim();
            
            // 1. Check Range (HH:MM - HH:MM)
            let rangeMatch = str.match(/(\d{1,2}[:.]\d{2})\s*[-â€“]\s*(\d{1,2}[:.]\d{2})/);
            if(rangeMatch) {
                let s = parseToMins(rangeMatch[1]);
                let e = parseToMins(rangeMatch[2]);
                return e - s;
            }

            // 2. Check Explicit Duration (e.g., 8h, 30m)
            if(str.match(/\dh/i) || str.match(/\dm/i)) {
                 let h = parseInt(str.match(/(\d+)h/i)?.[1] || 0);
                 let m = parseInt(str.match(/(\d+)m/i)?.[1] || 0);
                 return (h * 60) + m;
            }

            // 3. Check Decimal or Clean Number (0.75 or 8)
            // Replace comma with dot
            let clean = str.replace(',', '.').replace(/[^\d.]/g, '');
            if(!isNaN(parseFloat(clean))) {
                return Math.round(parseFloat(clean) * 60);
            }

            return 0;
        }

        function parseToMins(timeStr) {
            timeStr = timeStr.replace('.', ':');
            let [h, m] = timeStr.split(':').map(Number);
            return (h * 60) + (m || 0);
        }

        function minsToTotalStr(mins) {
            let h = Math.floor(mins / 60);
            let m = Math.round(mins % 60);
            return `${h}:${m.toString().padStart(2,'0')}`;
        }

        function processData() {
            const raw = document.getElementById('rawInput').value;
            const lines = raw.split('\n');
            entries = [];
            let hasErr = false;

            lines.forEach(line => {
                if(!line.trim()) return;
                
                let e = { original: line, date: '', client: '', displayTime: '', minutes: 0, error: false };

                // 1. Date (Start of line)
                let dateMatch = line.match(/^(\d{1,2}[.,/-]\d{1,2})/);
                let rest = line;
                
                if(dateMatch) {
                    e.date = dateMatch[1].replace(/[.,/]/, '-');
                    rest = line.substring(dateMatch[0].length).trim();
                } else {
                    e.error = true;
                    e.client = line; // Fail safe
                }

                // 2. Extract Time String (End of line usually)
                // Look for Range first
                let rangeMatch = rest.match(/(\d{1,2}[:.]\d{2})\s*[-â€“]\s*(\d{1,2}[:.]\d{2})/);
                // Look for Decimal/Hours at end
                let decimalMatch = rest.match(/(\d+([.,]\d+)?\s*[h]?)$/i);
                
                if(rangeMatch) {
                    e.displayTime = rangeMatch[0]; // Exact text
                    e.minutes = calculateMinutes(e.displayTime);
                    e.client = rest.replace(e.displayTime, '').trim();
                } else if(decimalMatch) {
                    e.displayTime = decimalMatch[0].trim(); // Exact text (e.g. 0.75)
                    e.minutes = calculateMinutes(e.displayTime);
                    e.client = rest.substring(0, decimalMatch.index).trim();
                } else {
                    // Fallback: try to find anything looking like time
                    e.error = true;
                    e.client = rest;
                }

                if(!e.client) e.client = "?";
                if(e.minutes <= 0 && !e.error) { e.error = true; } // Flag if calc failed

                entries.push(e);
                if(e.error) hasErr = true;
            });

            originalEntries = [...entries];
            renderTable();
            document.getElementById('resultCard').style.display = 'block';
            if(window.innerWidth < 768) document.getElementById('resultCard').scrollIntoView({behavior:'smooth'});
            showToast(hasErr ? translations[currentLang].toast_err : translations[currentLang].toast_gen, hasErr);
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            let totalMins = 0;

            entries.forEach((e, i) => {
                let tr = document.createElement('tr');
                if(e.error) tr.className = 'error-row';
                tr.onclick = () => openEdit(i);

                tr.innerHTML = `
                    <td style="width:20%">${e.date}</td>
                    <td class="client-col">${e.client}</td>
                    <td class="time-col">${e.displayTime || '?'}</td>
                `;
                if(!e.error) totalMins += e.minutes;
                tbody.appendChild(tr);
            });
            
            document.getElementById('summaryValue').innerText = minsToTotalStr(totalMins);
        }

        // --- EDITING ---
        function openEdit(i) {
            let e = entries[i];
            document.getElementById('editIndex').value = i;
            document.getElementById('editDate').value = e.date;
            document.getElementById('editClient').value = e.client;
            document.getElementById('editDisplayTime').value = e.displayTime;
            openModal('editModal');
        }

        function saveEdit() {
            let i = document.getElementById('editIndex').value;
            let e = entries[i];
            e.date = document.getElementById('editDate').value;
            e.client = document.getElementById('editClient').value;
            e.displayTime = document.getElementById('editDisplayTime').value;
            
            // Recalculate logic based on new display string
            e.minutes = calculateMinutes(e.displayTime);
            e.error = (e.minutes <= 0);

            renderTable();
            closeModal('editModal');
        }

        function deleteEntry() {
            entries.splice(document.getElementById('editIndex').value, 1);
            if(originalEntries) originalEntries = [...entries];
            renderTable(); closeModal('editModal');
        }

        // --- PDF ---
        function generatePDF(langCode) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const t = translations[langCode];
            
            // Modern Corporate Styling
            const colHeader = [245, 247, 250]; // Light grey bg
            const colText = [44, 62, 80]; // Dark blue text
            const colLine = [189, 195, 199];

            // Header Section
            doc.setFont("helvetica", "bold");
            doc.setFontSize(20);
            doc.setTextColor(...colText);
            doc.text(document.getElementById('headerInput').value.toUpperCase(), 14, 20);

            doc.setLineWidth(0.5);
            doc.setDrawColor(...colLine);
            doc.line(14, 25, 196, 25);

            // Metadata
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(100);
            doc.text(`${t.pdf_gen}: ${new Date().toLocaleDateString()}`, 196, 20, { align: 'right' });

            // Table Data
            let body = entries.map(e => [e.date, e.client, e.displayTime]);
            let totalMins = entries.reduce((acc, e) => acc + e.minutes, 0);

            // Total Row (Styled differently)
            body.push(['', '', { content: `${t.sum}: ${minsToTotalStr(totalMins)}`, styles: { fontStyle: 'bold', halign: 'right', fillColor: [240, 240, 240], textColor: colText } }]);

            doc.autoTable({
                startY: 35,
                head: [[t.date.toUpperCase(), t.client.toUpperCase(), t.time.toUpperCase()]],
                body: body,
                theme: 'plain', // Clean modern look
                headStyles: { 
                    fillColor: colHeader, 
                    textColor: colText, 
                    fontStyle: 'bold',
                    lineWidth: { bottom: 0.5 },
                    lineColor: colLine
                },
                styles: { 
                    fontSize: 10, 
                    cellPadding: 4, 
                    textColor: colText,
                    lineColor: [240, 240, 240],
                    lineWidth: { bottom: 0.1 }
                },
                columnStyles: { 
                    0: { cellWidth: 30 }, 
                    1: { cellWidth: 'auto' }, 
                    2: { cellWidth: 40, halign: 'right', fontStyle: 'bold' } 
                },
                didDrawPage: function (data) {
                    // Footer
                    let pageStr = `${t.pdf_page} ${doc.internal.getNumberOfPages()}`;
                    doc.setFontSize(8);
                    doc.setTextColor(150);
                    doc.text(pageStr, 196, 290, { align: 'right' });
                }
            });

            doc.save('TimeReport_WojThom.pdf');
            closeModal('exportModal');
        }

        // --- UTILS ---
        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('wt6_lang', lang);
            const t = translations[lang];
            
            const ids = {
                'lbl_header': t.header, 'lbl_input': t.input, 'btn_generate': t.generate, 'lbl_result': t.result,
                'th_date': t.date, 'th_client': t.client, 'th_time': t.time, 'lbl_total': t.total,
                'txt_menu_file': t.file, 'txt_menu_tools': t.tools, 'txt_menu_settings': t.settings,
                'txt_export': t.export, 'txt_clear': t.clear, 'txt_stats': t.stats, 'txt_filter': t.filter, 'txt_theme': t.theme,
                'modal_edit_title': t.edit_title, 'lbl_edit_date': t.date, 'lbl_edit_client': t.client, 'lbl_edit_display': t.display_time,
                'btn_save': t.save, 'btn_cancel': t.cancel, 'btn_delete': t.delete, 'modal_export_title': t.export_title,
                'modal_filter_title': t.filter_title, 'btn_reset': t.reset, 'btn_apply': t.apply, 'txt_stats_title': t.stats
            };
            for(let id in ids) { let el = document.getElementById(id); if(el) el.innerText = ids[id]; }
            if(entries.length) renderTable();
            document.getElementById('mainMenu').classList.remove('open');
            document.getElementById('menuOverlay').style.display = 'none';
        }

        function openModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
        function showToast(msg, err=false) {
            let t = document.getElementById('toast');
            t.innerHTML = (err ? '<i class="fas fa-exclamation-circle"></i> ' : '<i class="fas fa-check"></i> ') + msg;
            t.style.background = err ? 'var(--danger)' : '#333';
            t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 3000);
        }
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('wt6_theme', document.body.classList.contains('dark-mode')?'dark':'light');
            document.getElementById('mainMenu').classList.remove('open');
            document.getElementById('menuOverlay').style.display = 'none';
        }
        function clearData() {
            if(confirm("Are you sure?")) {
                document.getElementById('rawInput').value=''; entries=[]; 
                localStorage.setItem('wt6_rawInput','');
                document.getElementById('resultCard').style.display='none';
                document.getElementById('mainMenu').classList.remove('open');
                document.getElementById('menuOverlay').style.display = 'none';
            }
        }
        function resetFilter() { if(originalEntries) entries=[...originalEntries]; renderTable(); closeModal('filterModal'); }
        function applyFilter() { let v=document.getElementById('filterClient').value; if(v && originalEntries) entries=originalEntries.filter(e=>e.client===v); renderTable(); closeModal('filterModal'); }
        document.querySelector('[onclick="openModal(\'filterModal\')"]').addEventListener('click', ()=>{
            const s=document.getElementById('filterClient'); s.innerHTML=`<option value="">${translations[currentLang].reset}</option>`;
            [...new Set(entries.map(e=>e.client))].sort().forEach(c=>{let o=document.createElement('option');o.value=c;o.innerText=c;s.appendChild(o)});
        });
        function showStatistics() {
            if(!entries.length) return;
            openModal('statsModal');
            const data={}; entries.forEach(e=>{if(e.minutes>0) data[e.client]=(data[e.client]||0)+e.minutes/60});
            const ctx=document.getElementById('chartCanvas').getContext('2d');
            if(myChart) myChart.destroy();
            myChart=new Chart(ctx,{type:'pie',data:{labels:Object.keys(data),datasets:[{data:Object.values(data),backgroundColor:['#3498db','#e74c3c','#f1c40f','#2ecc71','#9b59b6']}]},options:{responsive:true,maintainAspectRatio:false}});
        }
    </script>
</body>
</html>
