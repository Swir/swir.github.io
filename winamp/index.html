<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Winamp Html - Working Edition</title>
  
  <!-- Webamp -->
  <script src="https://unpkg.com/webamp@1.5.0/built/webamp.bundle.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      font-size: 11px;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    #app {
      position: relative !important;
    }

    /* Winamp-style controls */
    .controls {
      background: linear-gradient(to bottom, #3a3a3a, #1e1e1e);
      border: 1px solid #000;
      box-shadow: inset 1px 1px 0 #555, inset -1px -1px 0 #222;
      padding: 5px;
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
      justify-content: center;
      max-width: 550px;
    }

    .btn {
      background: linear-gradient(to bottom, #4a4a4a, #2a2a2a);
      border: 1px solid #000;
      box-shadow: inset 1px 1px 0 #666, inset -1px -1px 0 #111;
      color: #00ff00;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      text-transform: uppercase;
    }

    .btn:hover {
      background: linear-gradient(to bottom, #5a5a5a, #3a3a3a);
    }

    .btn:active {
      background: linear-gradient(to bottom, #2a2a2a, #4a4a4a);
      box-shadow: inset -1px -1px 0 #666, inset 1px 1px 0 #111;
    }

    input[type="file"] {
      display: none;
    }

    /* Info panel */
    .info {
      background: #1a1a1a;
      border: 1px solid #333;
      padding: 10px;
      margin-top: 10px;
      font-family: monospace;
      font-size: 10px;
      color: #0f0;
      max-width: 550px;
      word-break: break-all;
    }

    .info div {
      margin: 2px 0;
    }

    /* Radio stations */
    .radio-list {
      display: none;
      background: #1a1a1a;
      border: 1px solid #333;
      padding: 5px;
      margin-top: 5px;
      max-width: 550px;
    }

    .radio-list.active {
      display: block;
    }

    .station {
      padding: 3px 8px;
      cursor: pointer;
      color: #aaa;
    }

    .station:hover {
      background: #333;
      color: #0f0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="app"></div>
    
    <div class="controls">
      <button class="btn" onclick="openFiles()">üìÅ PLIKI</button>
      <button class="btn" onclick="openFolder()">üìÇ FOLDER</button>
      <label class="btn" for="skinInput">üé® SK√ìRKA</label>
      <button class="btn" onclick="toggleRadio()">üìª RADIO</button>
      <button class="btn" onclick="clearAll()">üóëÔ∏è WYCZY≈öƒÜ</button>
      <button class="btn" onclick="testPlaylist()">üß™ TEST</button>
      <button class="btn" onclick="showDebug()">üêõ DEBUG</button>
    </div>

    <div class="radio-list" id="radioList">
      <div class="station" onclick="addStation('RMF FM', 'https://rs102-krk-cyfronet.rmfstream.pl/rmf_fm')">RMF FM</div>
      <div class="station" onclick="addStation('Radio ZET', 'https://zt.cdn.eurozet.pl/zet-net.mp3')">Radio ZET</div>
      <div class="station" onclick="addStation('Tr√≥jka', 'https://stream3.polskieradio.pl:8900/;')">Tr√≥jka</div>
      <div class="station" onclick="addStation('TOK FM', 'https://pl-play.adtonos.com/tok-fm')">TOK FM</div>
      <div class="station" onclick="addStation('Radio Maryja', 'https://radiomaryja.fastcast4u.com/proxy/radiomaryja?mp=/1')">Radio Maryja</div>
      <div class="station" onclick="addStation('Jazz Radio', 'https://stream.jazzy.hu/jazzy.mp3')">Jazz Radio</div>
      <div class="station" onclick="customStation()">‚ûï Dodaj w≈ÇasnƒÖ...</div>
    </div>

    <div class="info" id="info" style="display: none;"></div>
  </div>

  <input type="file" id="fileInput" multiple accept="audio/*">
  <input type="file" id="folderInput" webkitdirectory directory multiple>
  <input type="file" id="skinInput" accept=".wsz,.zip">

  <script>
    let webamp = null;

    // Initialize
    window.addEventListener('load', async () => {
      console.log('Initializing Winamp Html...');
      
      try {
        // Create Webamp with minimal config
        webamp = new Webamp({
          initialTracks: []
        });

        // Render
        await webamp.renderWhenReady(document.getElementById('app'));
        console.log('Webamp rendered successfully');
        
        // Set up file handlers
        setupFileHandlers();
        
        // Add a test track to verify it works
        addTestTrack();
        
      } catch (error) {
        console.error('Failed to initialize:', error);
        alert('B≈ÇƒÖd inicjalizacji Winampa: ' + error.message);
      }
    });

    // File handlers
    function setupFileHandlers() {
      // Regular files
      document.getElementById('fileInput').addEventListener('change', handleFiles);
      
      // Folder
      document.getElementById('folderInput').addEventListener('change', handleFiles);
      
      // Skin
      document.getElementById('skinInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
          try {
            const url = URL.createObjectURL(file);
            await webamp.setSkin({ url: url });
            console.log('Skin loaded');
          } catch (error) {
            console.error('Skin error:', error);
          }
        }
      });

      // Drag and drop
      document.addEventListener('dragover', e => e.preventDefault());
      document.addEventListener('drop', (e) => {
        e.preventDefault();
        const files = [...e.dataTransfer.files];
        processFiles(files);
      });
    }

    // Handle file input
    function handleFiles(e) {
      const files = [...e.target.files];
      processFiles(files);
      e.target.value = ''; // Reset
    }

    // Process files
    function processFiles(files) {
      console.log('Processing files:', files);
      
      const audioFiles = files.filter(f => {
        const name = f.name.toLowerCase();
        return name.endsWith('.mp3') || name.endsWith('.wav') || 
               name.endsWith('.ogg') || name.endsWith('.m4a') ||
               name.endsWith('.flac') || name.endsWith('.aac');
      });

      if (audioFiles.length === 0) {
        alert('Nie znaleziono plik√≥w audio');
        return;
      }

      // Method 1: Try native Webamp method first
      if (webamp.appendTracksFromFiles) {
        try {
          webamp.appendTracksFromFiles(audioFiles);
          console.log(`Added ${audioFiles.length} files via native method`);
          return;
        } catch (e) {
          console.log('Native method failed:', e);
        }
      }

      // Method 2: Create object URLs
      const tracks = audioFiles.map(file => {
        const url = URL.createObjectURL(file);
        return {
          url: url,
          defaultName: file.name,
          metaData: {
            artist: '',
            title: file.name.replace(/\.[^/.]+$/, '')
          }
        };
      });

      console.log('Adding tracks:', tracks);
      webamp.appendTracks(tracks);
    }

    // UI Functions
    function openFiles() {
      document.getElementById('fileInput').click();
    }

    function openFolder() {
      document.getElementById('folderInput').click();
    }

    function toggleRadio() {
      const list = document.getElementById('radioList');
      list.classList.toggle('active');
    }

    function addStation(name, url) {
      console.log('Adding station:', name, url);
      webamp.appendTracks([{
        url: url,
        defaultName: name,
        metaData: {
          artist: 'Radio',
          title: name
        }
      }]);
      toggleRadio();
    }

    function customStation() {
      const url = prompt('URL stacji:');
      if (url) {
        const name = prompt('Nazwa:') || 'Custom Radio';
        addStation(name, url);
      }
    }

    function clearAll() {
      if (confirm('Wyczy≈õciƒá playlistƒô?')) {
        // Get all track IDs and remove them
        const state = webamp.store.getState();
        const trackIds = Object.keys(state.playlist);
        
        trackIds.forEach(id => {
          webamp.store.dispatch({
            type: 'REMOVE_TRACKS',
            ids: [id]
          });
        });
        
        console.log('Playlist cleared');
      }
    }

    function testPlaylist() {
      console.log('Adding test tracks...');
      
      const testTracks = [
        {
          url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3',
          defaultName: 'Test Song 1',
          metaData: { artist: 'SoundHelix', title: 'Song 1' }
        },
        {
          url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3',
          defaultName: 'Test Song 2', 
          metaData: { artist: 'SoundHelix', title: 'Song 2' }
        }
      ];
      
      webamp.appendTracks(testTracks);
    }

    function addTestTrack() {
      // Add one test track on startup
      webamp.appendTracks([{
        url: 'https://ia800604.us.archive.org/16/items/SynthwaveOutrun/01.%20Eu%20N√£o%20Quero%20Falar%20Sobre%20Isso.mp3',
        defaultName: 'Welcome to Winamp Html',
        metaData: {
          artist: 'Winamp Html',
          title: 'Welcome Track'
        }
      }]);
    }

    function showDebug() {
      const info = document.getElementById('info');
      const state = webamp.store.getState();
      
      const playlist = state.playlist || {};
      const tracks = state.tracks || {};
      const trackCount = Object.keys(playlist).length;
      
      let html = `<div>WEBAMP DEBUG INFO</div>`;
      html += `<div>==================</div>`;
      html += `<div>Tracks in playlist: ${trackCount}</div>`;
      html += `<div>Current track: ${state.media?.currentTrack || 'none'}</div>`;
      html += `<div>Status: ${state.media?.status || 'unknown'}</div>`;
      html += `<div>==================</div>`;
      
      Object.entries(playlist).forEach(([id, order]) => {
        const track = tracks[id];
        if (track) {
          html += `<div>${order}: ${track.defaultName || track.url}</div>`;
        }
      });
      
      info.innerHTML = html;
      info.style.display = info.style.display === 'none' ? 'block' : 'none';
      
      console.log('Full state:', state);
    }

    // Global error handler
    window.addEventListener('error', (e) => {
      console.error('Global error:', e);
    });
  </script>
</body>
</html>
