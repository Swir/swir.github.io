<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
  <title>Winamp Ultimate Pro Max - Ultimate Music Experience</title>
  
  <!-- PWA Meta -->
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Winamp Ultimate Pro Max">
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiV2luYW1wIFVsdGltYXRlIFBybyBNYXgiLCJzaG9ydF9uYW1lIjoiV2luYW1wIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwidGhlbWVfY29sb3IiOiIjMDAwMDAwIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwMDAwMDAiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TWpBd01DOXpkbWNpSUhkcFpIUm9QU0kxTVRJaUlHaGxhV2RvZEQwaU5URXlJajQ4Y21WamRDQjNhV1IwYUQwaU5URXlJaUJvWldsbmFIUTlJa0UxTVRJaUlHWnBiR3c5SWlNd01HWm1OREVSTHB3OEwzTjJaejQ9Iiwic2l6ZXMiOiI1MTJ4NTEyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">
  
  <!-- Webamp -->
  <script src="https://unpkg.com/webamp@1.5.0/built/webamp.bundle.min.js"></script>
  
  <style>
    :root {
      --primary-bg: #0a0a0a;
      --secondary-bg: #151515;
      --tertiary-bg: #202020;
      --glass-bg: rgba(255, 255, 255, 0.03);
      --glass-border: rgba(255, 255, 255, 0.1);
      --accent-primary: #00ff41;
      --accent-secondary: #ff3366;
      --accent-tertiary: #3366ff;
      --accent-gold: #ffd700;
      --accent-purple: #9d4edd;
      --accent-cyan: #06ffa5;
      --text-primary: #ffffff;
      --text-secondary: #b0b0b0;
      --text-muted: #666666;
      --shadow-primary: 0 8px 32px rgba(0, 255, 65, 0.15);
      --shadow-secondary: 0 4px 16px rgba(0, 0, 0, 0.3);
      --shadow-intense: 0 12px 48px rgba(0, 255, 65, 0.25);
      --glow-primary: 0 0 30px rgba(0, 255, 65, 0.4);
      --glow-secondary: 0 0 20px rgba(255, 51, 102, 0.3);
      --glow-intense: 0 0 50px rgba(0, 255, 65, 0.6);
      --gradient-primary: linear-gradient(135deg, var(--accent-primary), var(--accent-tertiary));
      --gradient-secondary: linear-gradient(135deg, var(--accent-secondary), var(--accent-gold));
      --gradient-glass: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.02));
      --gradient-rainbow: linear-gradient(90deg, #ff0000, #ff8000, #ffff00, #80ff00, #00ff00, #00ff80, #00ffff, #0080ff, #0000ff, #8000ff, #ff00ff, #ff0080);
      --gradient-cyber: linear-gradient(135deg, #00ff41, #06ffa5, #3366ff, #9d4edd);
    }

    /* THEMES */
    body.theme-retro {
      --accent-primary: #ff6b35;
      --accent-secondary: #f7931e;
      --accent-tertiary: #ffd23f;
      --gradient-primary: linear-gradient(135deg, #ff6b35, #f7931e);
    }

    body.theme-neon {
      --accent-primary: #ff073a;
      --accent-secondary: #39ff14;
      --accent-tertiary: #0ff0fc;
      --gradient-primary: linear-gradient(135deg, #ff073a, #39ff14);
    }

    body.theme-ocean {
      --accent-primary: #006994;
      --accent-secondary: #47a8bd;
      --accent-tertiary: #f1f7ee;
      --gradient-primary: linear-gradient(135deg, #006994, #47a8bd);
    }

    body.theme-sunset {
      --accent-primary: #ff9a8b;
      --accent-secondary: #f6416c;
      --accent-tertiary: #00b8a9;
      --gradient-primary: linear-gradient(135deg, #ff9a8b, #f6416c);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: var(--primary-bg);
      background-image: 
        radial-gradient(circle at 20% 30%, rgba(0, 255, 65, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(255, 51, 102, 0.06) 0%, transparent 50%),
        radial-gradient(circle at 50% 50%, rgba(51, 102, 255, 0.04) 0%, transparent 50%),
        linear-gradient(135deg, #0a0a0a 0%, #151515 50%, #0a0a0a 100%);
      background-attachment: fixed;
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      font-size: 14px;
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 20px;
      touch-action: manipulation;
      overflow-x: hidden;
      transition: all 0.3s ease;
      /* Prevent touch conflicts */
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    /* Better touch targets for mobile */
    @media (max-width: 768px) {
      body {
        padding: 15px;
        font-size: 16px; /* Larger text on mobile */
      }
    }

    body.party-mode {
      animation: partyPulse 2s ease-in-out infinite alternate;
    }

    @keyframes partyPulse {
      0% { filter: hue-rotate(0deg) saturate(1); }
      100% { filter: hue-rotate(60deg) saturate(1.2); }
    }

    .container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      max-width: 1600px;
      margin: 0 auto;
      flex-grow: 1;
      position: relative;
      gap: 20px;
    }

    .main-content {
      position: relative;
      transition: margin 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Desktop sidebar margins */
    @media (min-width: 1200px) {
      .main-content.radio-open {
        margin-right: 380px;
      }

      .main-content.equalizer-open {
        margin-left: 320px;
      }

      .main-content.both-open {
        margin-left: 320px;
        margin-right: 380px;
      }
    }

    .floating-orbs {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
      overflow: hidden;
    }

    .orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(60px);
      animation: float 20s ease-in-out infinite;
      opacity: 0.3;
      transition: all 0.5s ease;
    }

    .orb:nth-child(1) {
      width: 200px;
      height: 200px;
      background: var(--accent-primary);
      top: 20%;
      left: 10%;
      animation-duration: 25s;
    }

    .orb:nth-child(2) {
      width: 150px;
      height: 150px;
      background: var(--accent-secondary);
      top: 60%;
      right: 15%;
      animation-duration: 30s;
      animation-delay: -10s;
    }

    .orb:nth-child(3) {
      width: 180px;
      height: 180px;
      background: var(--accent-tertiary);
      bottom: 20%;
      left: 60%;
      animation-duration: 35s;
      animation-delay: -20s;
    }

    @keyframes float {
      0%, 100% { 
        transform: translate(0, 0) rotate(0deg) scale(1); 
        filter: blur(60px) hue-rotate(0deg);
      }
      25% { 
        transform: translate(30px, -30px) rotate(90deg) scale(1.1); 
        filter: blur(50px) hue-rotate(90deg);
      }
      50% { 
        transform: translate(-20px, 20px) rotate(180deg) scale(0.9); 
        filter: blur(70px) hue-rotate(180deg);
      }
      75% { 
        transform: translate(20px, 30px) rotate(270deg) scale(1.05); 
        filter: blur(55px) hue-rotate(270deg);
      }
    }

    /* NOW PLAYING DISPLAY */
    .now-playing-display {
      background: var(--glass-bg);
      backdrop-filter: blur(30px);
      border: 2px solid var(--glass-border);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 20px;
      order: 0;
      box-shadow: var(--shadow-primary);
      transition: all 0.4s ease;
      position: relative;
      overflow: hidden;
    }

    .now-playing-display::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--gradient-rainbow);
      animation: rainbowShift 3s linear infinite;
    }

    .now-playing-display:hover {
      box-shadow: var(--glow-primary);
      border-color: var(--accent-primary);
      transform: translateY(-2px);
    }

    .album-art {
      width: 80px;
      height: 80px;
      border-radius: 12px;
      background: var(--gradient-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0;
      animation: spin 20s linear infinite;
    }

    .album-art.playing {
      animation: spin 4s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .track-info {
      flex: 1;
      min-width: 0;
    }

    .track-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .track-artist {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .track-progress {
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
      overflow: hidden;
      position: relative;
    }

    .track-progress-bar {
      height: 100%;
      background: var(--gradient-primary);
      width: 0%;
      border-radius: 2px;
      transition: width 0.3s ease;
    }

    .track-controls {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-shrink: 0;
    }

    .control-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 24px;
      cursor: pointer;
      transition: all 0.3s ease;
      padding: 15px; /* Larger touch target */
      border-radius: 50%;
      min-width: 50px; /* Minimum touch target */
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
    }

    .control-btn:hover, .control-btn:focus {
      color: var(--accent-primary);
      background: rgba(0, 255, 65, 0.1);
      transform: scale(1.1);
      outline: none;
    }

    .control-btn:active {
      transform: scale(0.95);
    }

    /* TRACK STATS CONTAINER */
    .track-stats-container {
      background: var(--glass-bg);
      backdrop-filter: blur(30px);
      border: 2px solid var(--glass-border);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 20px;
      order: 0.5;
      box-shadow: var(--shadow-primary);
      transition: all 0.4s ease;
    }

    .track-stats-container:hover {
      box-shadow: var(--glow-primary);
      border-color: var(--accent-primary);
    }

    .track-stats-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .track-stats-title {
      color: var(--accent-primary);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .track-stats-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease;
    }

    .track-stats-content.show {
      max-height: 200px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .stat-item {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 12px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .stat-item:hover {
      background: rgba(0, 255, 65, 0.1);
      transform: translateY(-2px);
    }

    .stat-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 14px;
      font-weight: 700;
      color: var(--accent-primary);
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
      
      .stat-item {
        padding: 10px;
      }
      
      .stat-value {
        font-size: 12px;
      }
    }

    #app {
      position: relative !important;
      flex-grow: 1;
      border-radius: 20px;
      overflow: hidden;
      backdrop-filter: blur(25px);
      background: var(--glass-bg);
      border: 2px solid var(--glass-border);
      box-shadow: var(--shadow-intense);
      min-height: 480px;
      order: 1;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    #app:hover {
      box-shadow: var(--glow-intense);
      border-color: var(--accent-primary);
    }

    .controls {
      background: var(--glass-bg);
      backdrop-filter: blur(30px);
      border: 2px solid var(--glass-border);
      border-radius: 25px;
      padding: 25px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 20px;
      justify-content: center;
      align-items: center;
      order: 3;
      width: 100%;
      box-shadow: var(--shadow-primary);
      position: relative;
      overflow: hidden;
      transition: all 0.4s ease;
    }

    .controls::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      animation: shimmer 8s infinite;
    }

    .controls:hover {
      box-shadow: var(--glow-primary);
      border-color: var(--accent-primary);
    }

    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    .btn {
      background: var(--gradient-glass);
      backdrop-filter: blur(20px);
      border: 2px solid var(--glass-border);
      border-radius: 15px;
      color: var(--accent-primary);
      padding: 18px 25px; /* Larger padding for mobile */
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      text-transform: uppercase;
      text-align: center;
      min-width: 140px;
      min-height: 50px; /* Minimum touch target */
      touch-action: manipulation;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      letter-spacing: 1px;
      white-space: nowrap;
      flex: 0 0 auto;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: var(--gradient-primary);
      opacity: 0;
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.3), transparent);
      transition: all 0.6s ease;
      border-radius: 50%;
      transform: translate(-50%, -50%);
    }

    .btn:hover, .btn:focus {
      transform: translateY(-3px) scale(1.02);
      box-shadow: var(--glow-primary);
      border-color: var(--accent-primary);
      color: var(--text-primary);
      outline: none;
    }

    .btn:hover::before, .btn:focus::before {
      left: 0;
      opacity: 0.3;
    }

    .btn:hover::after, .btn:focus::after {
      width: 100px;
      height: 100px;
    }

    .btn:active {
      transform: translateY(-1px) scale(0.98);
    }

    .btn.active {
      background: var(--gradient-primary);
      color: var(--primary-bg);
      box-shadow: var(--glow-intense);
      border-color: var(--accent-primary);
    }

    .btn.premium {
      background: var(--gradient-secondary);
      border-color: var(--accent-gold);
      color: var(--accent-gold);
    }

    .btn.premium:hover {
      box-shadow: 0 0 50px rgba(255, 215, 0, 0.6);
    }

    .info {
      background: var(--glass-bg);
      backdrop-filter: blur(30px);
      border: 2px solid var(--glass-border);
      border-radius: 20px;
      padding: 30px;
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', monospace;
      font-size: 12px;
      color: var(--accent-primary);
      word-break: break-word;
      order: 2;
      box-shadow: var(--shadow-primary);
      max-height: 450px;
      overflow-y: auto;
      transition: all 0.4s ease;
    }

    .info:hover {
      box-shadow: var(--glow-primary);
      border-color: var(--accent-primary);
    }

    .info::-webkit-scrollbar {
      width: 12px;
    }

    .info::-webkit-scrollbar-track {
      background: var(--tertiary-bg);
      border-radius: 6px;
    }

    .info::-webkit-scrollbar-thumb {
      background: var(--gradient-primary);
      border-radius: 6px;
      border: 2px solid var(--tertiary-bg);
    }

    .info::-webkit-scrollbar-thumb:hover {
      background: var(--gradient-secondary);
    }

    /* SIDEBAR IMPROVEMENTS */
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 998;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      touch-action: none;
    }

    .sidebar-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    /* MOBILE SIDEBAR STYLES */
    .sidebar {
      position: fixed;
      top: 0;
      width: 90vw;
      max-width: 400px;
      height: 100vh;
      background: rgba(10, 10, 10, 0.98);
      backdrop-filter: blur(40px);
      border: 2px solid var(--glass-border);
      box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
      z-index: 999;
      display: flex;
      flex-direction: column;
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
    }

    .sidebar.left {
      left: 0;
      transform: translateX(-100%);
      border-right: 2px solid var(--glass-border);
    }

    .sidebar.right {
      right: 0;
      transform: translateX(100%);
      border-left: 2px solid var(--glass-border);
    }

    .sidebar.active {
      transform: translateX(0);
    }

    .sidebar-header {
      padding: 25px 20px 20px;
      border-bottom: 1px solid var(--glass-border);
      background: rgba(0, 255, 65, 0.05);
      flex-shrink: 0;
    }

    .sidebar-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .sidebar-title h3 {
      color: var(--accent-primary);
      font-size: 16px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .sidebar-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 24px;
      cursor: pointer;
      transition: all 0.3s ease;
      padding: 10px;
      border-radius: 50%;
      min-width: 44px;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
    }

    .sidebar-close:hover, .sidebar-close:focus {
      color: var(--accent-primary);
      background: rgba(0, 255, 65, 0.1);
      transform: scale(1.1);
      outline: none;
    }

    .sidebar-close:active {
      transform: scale(0.9);
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      -webkit-overflow-scrolling: touch;
    }

    .sidebar-content::-webkit-scrollbar {
      width: 6px;
    }

    .sidebar-content::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 3px;
    }

    .sidebar-content::-webkit-scrollbar-thumb {
      background: var(--accent-primary);
      border-radius: 3px;
    }

    /* RADIO SPECIFIC STYLES */
    .radio-search-container {
      position: relative;
      margin-bottom: 15px;
    }

    .radio-search-input {
      width: 100%;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid var(--glass-border);
      border-radius: 10px;
      padding: 15px 50px 15px 15px;
      color: var(--text-primary);
      font-size: 16px;
      transition: all 0.3s ease;
      -webkit-tap-highlight-color: transparent;
    }

    .radio-search-input:focus {
      outline: none;
      border-color: var(--accent-primary);
      background: rgba(255, 255, 255, 0.08);
      box-shadow: 0 0 15px rgba(0, 255, 65, 0.2);
    }

    .radio-search-icon {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 16px;
      pointer-events: none;
    }

    .radio-category-select {
      width: 100%;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid var(--glass-border);
      border-radius: 10px;
      padding: 15px;
      color: var(--accent-primary);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      -webkit-tap-highlight-color: transparent;
    }

    .radio-category-select:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 15px rgba(0, 255, 65, 0.2);
    }

    .radio-stats-bar {
      padding: 15px 0;
      background: rgba(0, 255, 65, 0.03);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--text-secondary);
      margin: 0 -20px 20px -20px;
      padding-left: 20px;
      padding-right: 20px;
    }

    .radio-stat {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .radio-stat .number {
      color: var(--accent-primary);
      font-weight: 700;
    }

    .radio-station-item {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      margin-bottom: 10px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    .radio-station-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 4px;
      background: var(--gradient-primary);
      transform: scaleY(0);
      transition: transform 0.3s ease;
    }

    .radio-station-item:hover, .radio-station-item:focus {
      background: rgba(0, 255, 65, 0.08);
      border-color: var(--accent-primary);
      transform: translateX(5px);
      box-shadow: 0 4px 15px rgba(0, 255, 65, 0.15);
    }

    .radio-station-item:hover::before, .radio-station-item:focus::before {
      transform: scaleY(1);
    }

    .radio-station-item:active {
      transform: translateX(2px) scale(0.98);
    }

    .radio-station-item.favorite {
      border-color: var(--accent-gold);
      background: rgba(255, 215, 0, 0.05);
    }

    .radio-station-item.offline {
      opacity: 0.6;
      border-color: var(--accent-secondary);
    }

    .radio-station-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .radio-station-name {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1.3;
      flex: 1;
      margin-right: 10px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .radio-station-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }

    .radio-play-btn, .radio-fav-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      padding: 10px;
      border-radius: 8px;
      min-width: 40px;
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
    }

    .radio-play-btn:hover, .radio-play-btn:focus {
      color: var(--accent-primary);
      background: rgba(0, 255, 65, 0.1);
      transform: scale(1.1);
      outline: none;
    }

    .radio-play-btn:active {
      transform: scale(0.9);
    }

    .radio-fav-btn:hover, .radio-fav-btn:focus {
      color: var(--accent-gold);
      background: rgba(255, 215, 0, 0.1);
      transform: scale(1.1);
      outline: none;
    }

    .radio-fav-btn:active {
      transform: scale(0.9);
    }

    .radio-fav-btn.active {
      color: var(--accent-gold);
      background: rgba(255, 215, 0, 0.15);
    }

    .radio-station-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-muted);
    }

    .radio-station-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .radio-country-flag {
      font-size: 14px;
    }

    .radio-genre-tag {
      background: rgba(0, 255, 65, 0.15);
      color: var(--accent-primary);
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .radio-quality-badge {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-secondary);
      padding: 3px 6px;
      border-radius: 4px;
      font-size: 9px;
      font-weight: 600;
    }

    .radio-quality-badge.hifi {
      background: var(--gradient-secondary);
      color: var(--primary-bg);
    }

    .radio-station-stats {
      font-size: 10px;
      color: var(--text-muted);
    }

    .radio-load-more {
      background: rgba(0, 255, 65, 0.1);
      border: 2px solid var(--accent-primary);
      border-radius: 12px;
      color: var(--accent-primary);
      padding: 15px;
      margin: 20px 0;
      text-align: center;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.3s ease;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .radio-load-more:hover, .radio-load-more:focus {
      background: var(--accent-primary);
      color: var(--primary-bg);
      transform: translateY(-2px);
      outline: none;
    }

    .radio-load-more:active {
      transform: translateY(0) scale(0.98);
    }

    /* THEME SIDEBAR */
    .theme-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }

    .theme-card {
      background: rgba(255, 255, 255, 0.02);
      border: 2px solid rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-align: center;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    .theme-card:hover, .theme-card:focus {
      background: rgba(255, 255, 255, 0.08);
      border-color: var(--accent-primary);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 255, 65, 0.15);
      outline: none;
    }

    .theme-card:active {
      transform: translateY(0) scale(0.98);
    }

    .theme-card.active {
      background: rgba(0, 255, 65, 0.1);
      border-color: var(--accent-primary);
      box-shadow: 0 0 20px rgba(0, 255, 65, 0.3);
    }

    .theme-preview {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      margin: 0 auto 10px auto;
      border: 3px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }

    .theme-card:hover .theme-preview {
      transform: scale(1.1);
      border-color: var(--accent-primary);
    }

    .theme-card.active .theme-preview {
      border-color: var(--accent-primary);
      box-shadow: 0 0 15px rgba(0, 255, 65, 0.5);
    }

    .theme-name {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 5px;
    }

    .theme-desc {
      font-size: 11px;
      color: var(--text-muted);
      line-height: 1.3;
    }

    .theme-default { background: linear-gradient(135deg, #00ff41, #3366ff); }
    .theme-retro { background: linear-gradient(135deg, #ff6b35, #f7931e); }
    .theme-neon { background: linear-gradient(135deg, #ff073a, #39ff14); }
    .theme-ocean { background: linear-gradient(135deg, #006994, #47a8bd); }
    .theme-sunset { background: linear-gradient(135deg, #ff9a8b, #f6416c); }
    .theme-cyber { background: linear-gradient(135deg, #00ff41, #06ffa5); }

    .theme-info {
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      margin-top: 20px;
      padding-top: 20px;
    }

    @media (max-width: 768px) {
      .theme-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .theme-card {
        padding: 12px;
      }
      
      .theme-preview {
        width: 50px;
        height: 50px;
      }
      
      .theme-name {
        font-size: 13px;
      }
      
      .theme-desc {
        font-size: 10px;
      }
    }

    .loading {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--glass-bg);
      backdrop-filter: blur(40px);
      border: 3px solid var(--accent-primary);
      border-radius: 25px;
      padding: 50px;
      z-index: 3000;
      box-shadow: var(--glow-intense);
    }

    .loading.active {
      display: flex;
      align-items: center;
      gap: 30px;
      animation: fadeInScale 0.5s ease;
    }

    @keyframes fadeInScale {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
      100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid var(--glass-border);
      border-top: 5px solid var(--accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 16px;
      font-weight: 700;
      color: var(--accent-primary);
      letter-spacing: 1px;
    }

    .notification {
      position: fixed;
      top: 30px;
      right: 30px;
      background: var(--glass-bg);
      backdrop-filter: blur(40px);
      border: 2px solid var(--accent-primary);
      border-radius: 15px;
      padding: 20px 30px;
      color: var(--accent-primary);
      font-size: 14px;
      font-weight: 700;
      z-index: 4000;
      transform: translateX(100%);
      opacity: 0;
      visibility: hidden;
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--glow-primary);
      max-width: 450px;
      min-width: 250px;
    }

    .notification.show {
      transform: translateX(0);
      opacity: 1;
      visibility: visible;
      animation: notificationPulse 0.6s ease;
    }

    @keyframes notificationPulse {
      0%, 100% { transform: translateX(0) scale(1); }
      50% { transform: translateX(0) scale(1.05); }
    }

    @keyframes rainbowShift {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .notification.success {
      border-color: #2ed573;
      color: #2ed573;
      box-shadow: 0 0 30px rgba(46, 213, 115, 0.4);
    }

    .notification.error {
      border-color: #ff4757;
      color: #ff4757;
      box-shadow: 0 0 30px rgba(255, 71, 87, 0.4);
    }

    .notification.warning {
      border-color: #ffa502;
      color: #ffa502;
      box-shadow: 0 0 30px rgba(255, 165, 2, 0.4);
    }

    .party-mode-indicator {
      position: fixed;
      top: 90px;
      left: 20px;
      background: var(--gradient-rainbow);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      animation: partyBounce 1s ease-in-out infinite alternate;
      z-index: 2000;
      box-shadow: 0 0 40px rgba(255, 255, 255, 0.5);
    }

    @keyframes partyBounce {
      0% { transform: scale(1) rotate(0deg); }
      100% { transform: scale(1.2) rotate(180deg); }
    }

    .equalizer-viz {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 200px;
      height: 80px;
      display: none;
      align-items: end;
      gap: 3px;
      z-index: 2000;
      padding: 10px;
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border-radius: 15px;
      border: 1px solid var(--glass-border);
    }

    .eq-bar {
      width: 8px;
      background: var(--gradient-primary);
      border-radius: 4px 4px 0 0;
      transition: height 0.1s ease;
      min-height: 5px;
    }

    /* Mobile Landscape/Portrait Handling */
    @media (max-width: 768px) and (orientation: landscape) {
      .container {
        gap: 10px;
      }
      
      .now-playing-display {
        flex-direction: row;
        padding: 15px;
        gap: 15px;
      }
      
      .track-info {
        width: auto;
      }
      
      .controls {
        padding: 15px;
        gap: 10px;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      }
      
      .btn {
        padding: 12px 16px;
        font-size: 11px;
        min-height: 40px;
      }
    }

    /* Very small screens (iPhone SE, etc.) */
    @media (max-width: 380px) {
      body {
        padding: 8px;
        font-size: 14px;
      }
      
      .container {
        gap: 12px;
      }
      
      .now-playing-display {
        padding: 15px;
      }
      
      .album-art {
        width: 50px;
        height: 50px;
        font-size: 18px;
      }
      
      .track-title {
        font-size: 14px;
      }
      
      .track-artist {
        font-size: 12px;
      }
      
      .control-btn {
        min-width: 44px;
        min-height: 44px;
        font-size: 18px;
        padding: 10px;
      }
      
      .controls {
        padding: 12px;
        gap: 8px;
        grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
      }
      
      .btn {
        min-width: 90px;
        padding: 12px 14px;
        font-size: 10px;
        min-height: 44px;
      }
      
      .sidebar {
        width: 100%;
        max-width: 100%;
      }
      
      .theme-card {
        padding: 10px;
      }
      
      .theme-preview {
        width: 45px;
        height: 45px;
      }
    }

    /* Better touch scrolling for iOS */
    .sidebar-content {
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }

    /* Prevent zoom on form inputs */
    input, select, textarea {
      font-size: 16px !important;
    }

    /* Better focus management for keyboard users */
    @media (min-width: 769px) {
      .btn:focus-visible,
      .control-btn:focus-visible,
      .radio-play-btn:focus-visible,
      .radio-fav-btn:focus-visible,
      .sidebar-close:focus-visible,
      .theme-card:focus-visible {
        outline: 2px solid var(--accent-primary);
        outline-offset: 2px;
      }
    }

    @media (max-width: 480px) {
      .btn {
        min-width: 100px;
        padding: 14px 16px;
        font-size: 12px;
      }

      .controls {
        padding: 15px;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      }

      .radio-station-name {
        font-size: 13px;
      }

      .radio-play-btn, .radio-fav-btn {
        min-width: 44px;
        min-height: 44px;
        font-size: 14px;
      }
    }

    input[type="file"] {
      display: none;
    }

    .toast-container {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 4000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 400px;
    }

    .toast {
      background: var(--glass-bg);
      backdrop-filter: blur(30px);
      border: 2px solid var(--glass-border);
      border-radius: 15px;
      padding: 15px 20px;
      color: var(--text-primary);
      font-size: 13px;
      font-weight: 600;
      transform: translateX(100%);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-secondary);
    }

    .toast.show {
      transform: translateX(0);
    }

    @media (max-width: 768px) {
      .toast-container {
        bottom: 20px;
        right: 20px;
        left: 20px;
        max-width: none;
      }
    }

    .hidden {
      display: none !important;
    }

    .api-status {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 10px;
      padding: 8px 12px;
      font-size: 11px;
      color: var(--text-secondary);
      z-index: 1000;
      transition: all 0.3s ease;
      opacity: 0.6;
    }

    .api-status:hover {
      opacity: 1;
    }

    .api-status.online {
      border-color: var(--accent-primary);
      color: var(--accent-primary);
    }

    .api-status.offline {
      border-color: var(--accent-secondary);
      color: var(--accent-secondary);
    }

    @media (max-width: 768px) {
      .api-status {
        bottom: 80px;
        right: 10px;
        font-size: 10px;
        padding: 6px 10px;
      }
    }

    /* SWIPE GESTURES */
    .swipe-indicator {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 2px solid var(--accent-primary);
      border-radius: 15px;
      padding: 20px;
      font-size: 18px;
      color: var(--accent-primary);
      z-index: 5000;
      opacity: 0;
      transition: all 0.3s ease;
      pointer-events: none;
    }

    .swipe-indicator.show {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1.1);
    }

    /* Prevent text selection on touch devices */
    .no-select {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    /* Better focus indicators for accessibility */
    .btn:focus-visible,
    .control-btn:focus-visible,
    .radio-play-btn:focus-visible,
    .radio-fav-btn:focus-visible,
    .sidebar-close:focus-visible,
    .theme-option:focus-visible {
      outline: 2px solid var(--accent-primary);
      outline-offset: 2px;
    }

    /* Smooth scrolling */
    html {
      scroll-behavior: smooth;
    }

    /* Reduce motion for users who prefer it */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
      
      .orb {
        animation: none;
      }
      
      .album-art {
        animation: none;
      }
    }
  </style>
</head>
<body>
  <div class="floating-orbs">
    <div class="orb"></div>
    <div class="orb"></div>
    <div class="orb"></div>
  </div>

  <!-- Theme Selector - Now as Sidebar -->
  <div class="sidebar left" id="themeSidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">
        <h3>🎨 Themes</h3>
        <button class="sidebar-close" onclick="toggleThemes()" aria-label="Close Themes">×</button>
      </div>
    </div>
    
    <div class="sidebar-content">
      <div class="theme-grid">
        <div class="theme-card active" onclick="app?.setTheme?.('default')" data-theme="default">
          <div class="theme-preview theme-default"></div>
          <div class="theme-name">Default Cyber</div>
          <div class="theme-desc">Green & Blue Matrix</div>
        </div>
        
        <div class="theme-card" onclick="app?.setTheme?.('retro')" data-theme="retro">
          <div class="theme-preview theme-retro"></div>
          <div class="theme-name">Retro Orange</div>
          <div class="theme-desc">Warm 80s Vibes</div>
        </div>
        
        <div class="theme-card" onclick="app?.setTheme?.('neon')" data-theme="neon">
          <div class="theme-preview theme-neon"></div>
          <div class="theme-name">Neon Pink</div>
          <div class="theme-desc">Hot Miami Nights</div>
        </div>
        
        <div class="theme-card" onclick="app?.setTheme?.('ocean')" data-theme="ocean">
          <div class="theme-preview theme-ocean"></div>
          <div class="theme-name">Ocean Blue</div>
          <div class="theme-desc">Deep Sea Calm</div>
        </div>
        
        <div class="theme-card" onclick="app?.setTheme?.('sunset')" data-theme="sunset">
          <div class="theme-preview theme-sunset"></div>
          <div class="theme-name">Sunset</div>
          <div class="theme-desc">Gradient Dreams</div>
        </div>
        
        <div class="theme-card" onclick="app?.setTheme?.('cyber')" data-theme="cyber">
          <div class="theme-preview theme-cyber"></div>
          <div class="theme-name">Cyber Green</div>
          <div class="theme-desc">Matrix Reloaded</div>
        </div>
      </div>
      
      <div class="theme-info">
        <div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 12px;">
          <div style="margin-bottom: 10px;">🎨 Choose your style</div>
          <div>Themes change colors, gradients and visual mood</div>
        </div>
      </div>
    </div>
  </div>

  <div class="party-mode-indicator" id="partyIndicator">🎉</div>
  
  <div class="equalizer-viz" id="equalizerViz">
    <!-- Dynamic bars will be generated -->
  </div>

  <div class="swipe-indicator" id="swipeIndicator"></div>

  <!-- Sidebar Overlays -->
  <div class="sidebar-overlay" id="radioOverlay"></div>
  <div class="sidebar-overlay" id="equalizerOverlay"></div>
  <div class="sidebar-overlay" id="playlistOverlay"></div>
  <div class="sidebar-overlay" id="themesOverlay"></div>

  <!-- Equalizer Sidebar -->
  <div class="sidebar left" id="equalizerSidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">
        <h3>🎛️ Equalizer</h3>
        <button class="sidebar-close" onclick="toggleEqualizer()" aria-label="Close Equalizer">×</button>
      </div>
    </div>
    
    <div class="sidebar-content">
      <div style="margin-bottom: 20px;">
        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px;">
          <button class="radio-play-btn" style="background: rgba(0,255,65,0.1); border: 1px solid var(--accent-primary); border-radius: 6px; color: var(--accent-primary); padding: 8px 12px; font-size: 11px;" onclick="app?.setEQPreset?.('flat')">Flat</button>
          <button class="radio-play-btn" style="background: rgba(0,255,65,0.1); border: 1px solid var(--accent-primary); border-radius: 6px; color: var(--accent-primary); padding: 8px 12px; font-size: 11px;" onclick="app?.setEQPreset?.('rock')">Rock</button>
          <button class="radio-play-btn" style="background: rgba(0,255,65,0.1); border: 1px solid var(--accent-primary); border-radius: 6px; color: var(--accent-primary); padding: 8px 12px; font-size: 11px;" onclick="app?.setEQPreset?.('pop')">Pop</button>
          <button class="radio-play-btn" style="background: rgba(0,255,65,0.1); border: 1px solid var(--accent-primary); border-radius: 6px; color: var(--accent-primary); padding: 8px 12px; font-size: 11px;" onclick="app?.setEQPreset?.('jazz')">Jazz</button>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: end; gap: 10px; height: 180px; margin-bottom: 30px;">
          <div style="display: flex; flex-direction: column; align-items: center; height: 100%;">
            <input type="range" style="writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 20px; height: 120px; background: rgba(255,255,255,0.1); border-radius: 10px;" min="-12" max="12" value="0" step="0.1" onchange="app?.updateEQ?.(0, this.value)">
            <div style="font-size: 9px; color: var(--text-muted); margin-top: 8px;">60Hz</div>
          </div>
          <div style="display: flex; flex-direction: column; align-items: center; height: 100%;">
            <input type="range" style="writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 20px; height: 120px; background: rgba(255,255,255,0.1); border-radius: 10px;" min="-12" max="12" value="0" step="0.1" onchange="app?.updateEQ?.(1, this.value)">
            <div style="font-size: 9px; color: var(--text-muted); margin-top: 8px;">170Hz</div>
          </div>
          <div style="display: flex; flex-direction: column; align-items: center; height: 100%;">
            <input type="range" style="writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 20px; height: 120px; background: rgba(255,255,255,0.1); border-radius: 10px;" min="-12" max="12" value="0" step="0.1" onchange="app?.updateEQ?.(2, this.value)">
            <div style="font-size: 9px; color: var(--text-muted); margin-top: 8px;">310Hz</div>
          </div>
          <div style="display: flex; flex-direction: column; align-items: center; height: 100%;">
            <input type="range" style="writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 20px; height: 120px; background: rgba(255,255,255,0.1); border-radius: 10px;" min="-12" max="12" value="0" step="0.1" onchange="app?.updateEQ?.(3, this.value)">
            <div style="font-size: 9px; color: var(--text-muted); margin-top: 8px;">600Hz</div>
          </div>
          <div style="display: flex; flex-direction: column; align-items: center; height: 100%;">
            <input type="range" style="writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 20px; height: 120px; background: rgba(255,255,255,0.1); border-radius: 10px;" min="-12" max="12" value="0" step="0.1" onchange="app?.updateEQ?.(4, this.value)">
            <div style="font-size: 9px; color: var(--text-muted); margin-top: 8px;">1kHz</div>
          </div>
        </div>
        
        <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <span style="color: var(--text-secondary); font-size: 12px; font-weight: 600;">🔊 Volume</span>
            <input type="range" style="width: 120px; height: 4px; border-radius: 2px; background: rgba(255,255,255,0.1);" min="0" max="100" value="100" onchange="app?.setVolume?.(this.value)">
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <span style="color: var(--text-secondary); font-size: 12px; font-weight: 600;">🌊 Reverb</span>
            <input type="range" style="width: 120px; height: 4px; border-radius: 2px; background: rgba(255,255,255,0.1);" min="0" max="100" value="0" onchange="app?.setReverb?.(this.value)">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Playlist Sidebar -->
  <div class="sidebar left" id="playlistSidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">
        <h3>📋 Playlist</h3>
        <button class="sidebar-close" onclick="togglePlaylist()" aria-label="Close Playlist">×</button>
      </div>
      
      <div style="display: flex; gap: 5px; margin-bottom: 15px;">
        <button class="radio-play-btn" style="background: var(--accent-purple); color: var(--primary-bg); border: 1px solid var(--accent-purple); border-radius: 6px; padding: 8px 12px; font-size: 11px; flex: 1;" onclick="app?.switchPlaylistTab?.('current')">Current</button>
        <button class="radio-play-btn" style="background: rgba(157,78,221,0.1); border: 1px solid var(--accent-purple); border-radius: 6px; color: var(--accent-purple); padding: 8px 12px; font-size: 11px; flex: 1;" onclick="app?.switchPlaylistTab?.('favorites')">Favorites</button>
        <button class="radio-play-btn" style="background: rgba(157,78,221,0.1); border: 1px solid var(--accent-purple); border-radius: 6px; color: var(--accent-purple); padding: 8px 12px; font-size: 11px; flex: 1;" onclick="app?.switchPlaylistTab?.('history')">History</button>
      </div>
    </div>
    
    <div class="sidebar-content" id="playlistList">
      <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
        <div style="font-size: 32px; margin-bottom: 15px;">📭</div>
        <div style="font-size: 14px;">Brak elementów</div>
      </div>
    </div>
  </div>
  
  <!-- Radio Sidebar -->
  <div class="sidebar right" id="radioSidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">
        <h3>📻 Radio</h3>
        <button class="sidebar-close" onclick="toggleRadio()" aria-label="Close Radio">×</button>
      </div>
      
      <div class="radio-search-container">
        <input type="text" class="radio-search-input" id="radioSearchInput" placeholder="Szukaj stacji, kraju, gatunku..." autocomplete="off">
        <span class="radio-search-icon">🔍</span>
      </div>
      
      <select class="radio-category-select" id="radioCategorySelect">
        <option value="popular">🔥 Najpopularniejsze</option>
        <option value="recent">🆕 Ostatnio dodane</option>
        <option value="top">⭐ Najwyżej oceniane</option>
        <option value="hifi">🎧 Hi-Fi (192k+)</option>
        <option value="poland">🇵🇱 Polska</option>
        <option value="usa">🇺🇸 USA</option>
        <option value="uk">🇬🇧 Wielka Brytania</option>
        <option value="germany">🇩🇪 Niemcy</option>
        <option value="rock">🎸 Rock</option>
        <option value="pop">🎵 Pop</option>
        <option value="jazz">🎷 Jazz</option>
        <option value="electronic">🎛️ Electronic</option>
        <option value="classical">🎼 Klasyczna</option>
        <option value="news">📰 Wiadomości</option>
        <option value="favorites">💫 Ulubione</option>
      </select>
    </div>
    
    <div class="radio-stats-bar" id="radioStatsBar">
      <div class="radio-stat">📻 <span class="number" id="stationCount">0</span> stacji</div>
      <div class="radio-stat">🟢 <span class="number" id="liveCount">0</span> online</div>
      <div class="radio-stat">💫 <span class="number" id="favCount">0</span> ulubionych</div>
    </div>
    
    <div class="sidebar-content" id="radioStationsList">
      <!-- Dynamic content -->
    </div>
    
    <div class="radio-load-more" id="radioLoadMore" onclick="loadMoreStations()">
      📡 WIĘCEJ STACJI
    </div>
  </div>
  
  <div class="container">
    <div class="main-content" id="mainContent">
      <!-- Now Playing Display -->
      <div class="now-playing-display" id="nowPlayingDisplay">
        <div class="album-art" id="albumArt">🎵</div>
        <div class="track-info">
          <div class="track-title" id="trackTitle">Winamp Ultimate Pro Max</div>
          <div class="track-artist" id="trackArtist">Wybierz utwór aby rozpocząć</div>
          <div class="track-progress">
            <div class="track-progress-bar" id="trackProgressBar"></div>
          </div>
        </div>
        <div class="track-controls">
          <button class="control-btn" onclick="app?.previousTrack?.()" title="Previous" aria-label="Previous track">⏮</button>
          <button class="control-btn" onclick="app?.playPause?.()" title="Play/Pause" id="playPauseBtn" aria-label="Play or pause">▶</button>
          <button class="control-btn" onclick="app?.nextTrack?.()" title="Next" aria-label="Next track">⏭</button>
          <button class="control-btn" onclick="app?.toggleShuffle?.()" title="Shuffle" id="shuffleBtn" aria-label="Toggle shuffle">🔀</button>
          <button class="control-btn" onclick="app?.toggleRepeat?.()" title="Repeat" id="repeatBtn" aria-label="Toggle repeat">🔁</button>
        </div>
      </div>

      <!-- Track Info & Stats -->
      <div class="track-stats-container" id="trackStatsContainer">
        <div class="track-stats-header">
          <span class="track-stats-title">📊 Track Info</span>
          <button class="control-btn" onclick="app?.toggleStats?.()" id="statsToggle" aria-label="Toggle track stats">📈</button>
        </div>
        <div class="track-stats-content" id="trackStatsContent">
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-label">Format</div>
              <div class="stat-value" id="trackFormat">MP3</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Duration</div>
              <div class="stat-value" id="trackDuration">0:00</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Bitrate</div>
              <div class="stat-value" id="trackBitrate">320k</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Sample Rate</div>
              <div class="stat-value" id="trackSampleRate">44.1kHz</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Channels</div>
              <div class="stat-value" id="trackChannels">Stereo</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Position</div>
              <div class="stat-value" id="trackPosition">0:00 / 0:00</div>
            </div>
          </div>
        </div>
      </div>
      
      <div id="app"></div>
      
      <div class="info" id="info" style="display: none;"></div>

      <div class="controls">
        <button class="btn" onclick="openFiles()" aria-label="Open audio files">📁 PLIKI</button>
        <button class="btn" onclick="openFolder()" aria-label="Open folder">📂 FOLDER</button>
        <label class="btn" for="skinInput" aria-label="Load skin">🎨 SKÓRKA</label>
        <button class="btn" onclick="toggleThemes()" id="themesBtn" aria-label="Toggle themes">🎨 THEMES</button>
        <button class="btn" onclick="togglePlaylist()" id="playlistBtn" aria-label="Toggle playlist">📋 PLAYLIST</button>
        <button class="btn" onclick="toggleEqualizer()" id="equalizerBtn" aria-label="Toggle equalizer">🎛️ EQ</button>
        <button class="btn" onclick="toggleRadio()" id="radioBtn" aria-label="Toggle radio">📻 RADIO</button>
        <button class="btn premium" onclick="togglePartyMode()" id="partyBtn" aria-label="Toggle party mode">🎉 PARTY</button>
        <button class="btn" onclick="clearAll()" aria-label="Clear playlist">🗑️ WYCZYŚĆ</button>
        <button class="btn" onclick="testPlaylist()" aria-label="Add test tracks">🧪 TEST</button>
        <button class="btn" onclick="showDebug()" id="debugBtn" aria-label="Show debug info">🐛 DEBUG</button>
        <button class="btn" onclick="installPWA()" id="installBtn" style="display: none;" aria-label="Install app">📱 INSTALL</button>
      </div>
    </div>
  </div>

  <div class="loading" id="loading">
    <div class="spinner"></div>
    <span class="loading-text">Ładowanie...</span>
  </div>

  <div class="notification" id="notification"></div>
  <div class="toast-container" id="toastContainer"></div>
  <div class="api-status" id="apiStatus">📡 Radio Browser API</div>

  <input type="file" id="fileInput" multiple accept="audio/*">
  <input type="file" id="folderInput" webkitdirectory directory multiple>
  <input type="file" id="skinInput" accept=".wsz,.zip">

  <script>
    // === ENHANCED APPLICATION STATE ===
    class WinampApp {
      constructor() {
        this.webamp = null;
        this.deferredPrompt = null;
        this.radioStations = [];
        this.filteredStations = [];
        this.favorites = new Set();
        this.recentlyPlayed = [];
        this.isPartyMode = false;
        this.isLoadingMore = false;
        this.currentRetries = new Map();
        this.maxRetries = 3;
        this.STORAGE_KEY = 'winamp_pro_max_settings';
        this.FAVORITES_KEY = 'winamp_pro_max_favorites';
        this.HISTORY_KEY = 'winamp_pro_max_history';
        this.currentTheme = 'default';
        this.currentPlaylistTab = 'current';
        
        // Audio Context & Analysis - SIMPLIFIED
        this.audioContext = null;
        
        // Track Stats
        this.isStatsVisible = false;
        this.currentTrackStats = {
          format: 'Unknown',
          duration: '0:00',
          bitrate: 'Unknown',
          sampleRate: 'Unknown',
          channels: 'Unknown',
          position: '0:00 / 0:00'
        };
        
        // Equalizer
        this.eqFilters = [];
        this.eqPresets = {
          flat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
          rock: [5, 4, 3, 1, -1, -1, 0, 2, 3, 4],
          pop: [2, 1, 0, -1, -2, -1, 0, 1, 2, 3],
          jazz: [4, 3, 1, 2, -1, -1, 0, 1, 2, 3],
          classical: [5, 4, 3, 2, -1, -1, -1, 0, 1, 2],
          electronic: [4, 3, 1, 0, -1, 2, 1, 1, 3, 4],
          bass: [7, 6, 5, 3, 1, 0, 0, 0, 0, 0],
          vocal: [1, 0, -1, -2, -1, 1, 2, 3, 3, 2]
        };
        
        // Touch & Swipe - IMPROVED
        this.isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        this.touchStartX = 0;
        this.touchStartY = 0;
        this.touchEndX = 0;
        this.touchEndY = 0;
        this.touchStartTime = 0;
        this.isTouchMoving = false;
        this.swipeThreshold = 100;
        this.timeThreshold = 500;
        
        // Debouncing and throttling
        this.searchTimeout = null;
        this.clickTimeout = null;
        this.lastClickTime = 0;
        
        // Now Playing State
        this.currentTrack = null;
        this.isPlaying = false;
        this.currentProgress = 0;
        
        this.initializeStations();
        this.loadFavorites();
        this.loadHistory();
        this.setupSwipeGestures();
      }

      // === IMPROVED TOUCH/SWIPE HANDLING ===
      setupSwipeGestures() {
        if (!this.isMobile) return;
        
        // Passive listeners for better performance
        document.addEventListener('touchstart', (e) => {
          // Only handle swipes on main content area
          if (e.target.closest('.sidebar') || e.target.closest('.controls') || e.target.closest('.btn')) {
            return;
          }
          
          this.touchStartX = e.changedTouches[0].screenX;
          this.touchStartY = e.changedTouches[0].screenY;
          this.touchStartTime = Date.now();
          this.isTouchMoving = false;
        }, { passive: true });
        
        document.addEventListener('touchmove', (e) => {
          // Prevent swipe if user is scrolling or interacting with controls
          if (e.target.closest('.sidebar') || e.target.closest('.controls')) {
            return;
          }
          
          this.isTouchMoving = true;
        }, { passive: true });
        
        document.addEventListener('touchend', (e) => {
          // Only process if not moving and on main content
          if (this.isTouchMoving || e.target.closest('.sidebar') || e.target.closest('.controls') || e.target.closest('.btn')) {
            return;
          }
          
          this.touchEndX = e.changedTouches[0].screenX;
          this.touchEndY = e.changedTouches[0].screenY;
          
          const timeDiff = Date.now() - this.touchStartTime;
          
          // Only handle quick swipes, not long touches
          if (timeDiff < this.timeThreshold) {
            this.handleSwipe();
          }
        }, { passive: true });

        // Add haptic feedback support
        this.setupHapticFeedback();
      }

      setupHapticFeedback() {
        // Check if device supports haptic feedback
        this.hasHapticFeedback = 'vibrate' in navigator;
        
        if (this.hasHapticFeedback) {
          console.log('📳 Haptic feedback available');
        }
      }

      triggerHapticFeedback(type = 'light') {
        if (!this.hasHapticFeedback || !this.isMobile) return;
        
        try {
          switch (type) {
            case 'light':
              navigator.vibrate(10);
              break;
            case 'medium':
              navigator.vibrate(25);
              break;
            case 'heavy':
              navigator.vibrate(50);
              break;
            case 'success':
              navigator.vibrate([10, 50, 10]);
              break;
            case 'error':
              navigator.vibrate([25, 25, 25]);
              break;
          }
        } catch (error) {
          console.warn('Haptic feedback failed:', error);
        }
      }

      handleSwipe() {
        const deltaX = this.touchEndX - this.touchStartX;
        const deltaY = this.touchEndY - this.touchStartY;
        
        // Check if swipe is long enough
        if (Math.abs(deltaX) > this.swipeThreshold && Math.abs(deltaX) > Math.abs(deltaY)) {
          this.triggerHapticFeedback('light');
          
          if (deltaX > 0) {
            // Swipe right - Previous track
            this.previousTrack();
            this.showSwipeIndicator('⏮ Previous');
          } else {
            // Swipe left - Next track
            this.nextTrack();
            this.showSwipeIndicator('⏭ Next');
          }
        } else if (Math.abs(deltaY) > this.swipeThreshold && Math.abs(deltaY) > Math.abs(deltaX)) {
          this.triggerHapticFeedback('light');
          
          if (deltaY > 0) {
            // Swipe down - Show playlist
            this.togglePlaylist();
            this.showSwipeIndicator('📋 Playlist');
          } else {
            // Swipe up - Show radio
            this.toggleRadio();
            this.showSwipeIndicator('📻 Radio');
          }
        }
      }

      showSwipeIndicator(text) {
        const indicator = document.getElementById('swipeIndicator');
        if (indicator) {
          indicator.textContent = text;
          indicator.classList.add('show');
          
          setTimeout(() => {
            indicator.classList.remove('show');
          }, 1500);
        }
      }

      // === IMPROVED CLICK HANDLING ===
      debounceClick(func, delay = 300) {
        const now = Date.now();
        if (now - this.lastClickTime < delay) {
          return;
        }
        this.lastClickTime = now;
        func();
      }

      // === TRACK STATS MANAGEMENT ===
      toggleStats() {
        this.isStatsVisible = !this.isStatsVisible;
        const content = document.getElementById('trackStatsContent');
        const btn = document.getElementById('statsToggle');
        
        if (content) {
          if (this.isStatsVisible) {
            content.classList.add('show');
            this.updateTrackStats();
          } else {
            content.classList.remove('show');
          }
        }
        
        if (btn) {
          btn.style.color = this.isStatsVisible ? 'var(--accent-primary)' : 'var(--text-muted)';
        }
        
        this.showNotification(
          this.isStatsVisible ? '📊 Track Stats ON' : '📴 Track Stats OFF',
          'info'
        );
      }

      updateTrackStats() {
        if (!this.webamp || !this.webamp.store) return;
        
        try {
          const state = this.webamp.store.getState();
          const currentTrackId = state.media?.currentTrack;
          const tracks = state.tracks || {};
          const timeElapsed = state.media?.timeElapsed || 0;
          const length = state.media?.length || 0;
          
          // Update position
          this.currentTrackStats.position = `${this.formatTime(timeElapsed)} / ${this.formatTime(length)}`;
          this.currentTrackStats.duration = this.formatTime(length);
          
          // Get track info if available
          if (currentTrackId && tracks[currentTrackId]) {
            const track = tracks[currentTrackId];
            
            // Try to extract format from URL or file name
            if (track.url) {
              const extension = track.url.split('.').pop()?.toLowerCase() || 'unknown';
              this.currentTrackStats.format = extension.toUpperCase();
            }
            
            // Extract info from metadata if available
            if (track.metaData) {
              // Check if it's a radio station with quality info
              if (track.metaData.artist && track.metaData.artist.includes('•')) {
                const parts = track.metaData.artist.split('•');
                for (let part of parts) {
                  part = part.trim();
                  if (part.includes('k')) {
                    this.currentTrackStats.bitrate = part;
                  }
                }
              }
            }
          }
          
          // Update UI
          this.displayTrackStats();
        } catch (error) {
          console.error('Error updating track stats:', error);
        }
      }

      displayTrackStats() {
        const elements = {
          trackFormat: document.getElementById('trackFormat'),
          trackDuration: document.getElementById('trackDuration'),
          trackBitrate: document.getElementById('trackBitrate'),
          trackSampleRate: document.getElementById('trackSampleRate'),
          trackChannels: document.getElementById('trackChannels'),
          trackPosition: document.getElementById('trackPosition')
        };
        
        if (elements.trackFormat) elements.trackFormat.textContent = this.currentTrackStats.format;
        if (elements.trackDuration) elements.trackDuration.textContent = this.currentTrackStats.duration;
        if (elements.trackBitrate) elements.trackBitrate.textContent = this.currentTrackStats.bitrate;
        if (elements.trackSampleRate) elements.trackSampleRate.textContent = this.currentTrackStats.sampleRate;
        if (elements.trackChannels) elements.trackChannels.textContent = this.currentTrackStats.channels;
        if (elements.trackPosition) elements.trackPosition.textContent = this.currentTrackStats.position;
      }

      formatTime(seconds) {
        if (!seconds || seconds === 0) return '0:00';
        
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      }

      // === EQUALIZER CONTROLS ===
      updateEQ(bandIndex, gain) {
        if (!this.eqFilters[bandIndex]) return;
        
        this.eqFilters[bandIndex].gain.value = parseFloat(gain);
        this.saveSettings();
      }

      setEQPreset(presetName) {
        if (!this.eqPresets[presetName]) return;
        
        const gains = this.eqPresets[presetName];
        const sliders = document.querySelectorAll('input[type="range"][onchange*="updateEQ"]');
        
        gains.forEach((gain, index) => {
          if (sliders[index]) {
            sliders[index].value = gain;
            this.updateEQ(index, gain);
          }
        });
        
        this.showNotification(`🎛️ EQ Preset: ${presetName.toUpperCase()}`, 'success');
      }

      setVolume(volume) {
        if (this.webamp && this.webamp.setVolume) {
          this.webamp.setVolume(volume / 100);
        }
      }

      setReverb(amount) {
        if (!this.audioContext) return;
        this.showToast(`🌊 Reverb: ${amount}%`);
      }

      // === THEME SYSTEM ===
      setTheme(themeName) {
        document.body.className = document.body.className.replace(/theme-\w+/g, '');
        
        if (themeName !== 'default') {
          document.body.classList.add(`theme-${themeName}`);
        }
        
        this.currentTheme = themeName;
        
        // Update active theme card
        document.querySelectorAll('.theme-card').forEach(card => card.classList.remove('active'));
        const activeCard = document.querySelector(`[data-theme="${themeName}"]`);
        if (activeCard) {
          activeCard.classList.add('active');
        }
        
        this.saveSettings();
        this.showNotification(`🎨 Theme: ${themeName.toUpperCase()}`, 'success');
        
        // Auto-close themes sidebar on mobile after selection
        if (this.isMobile) {
          setTimeout(() => this.toggleThemes(), 1500);
        }
      }

      // === NOW PLAYING DISPLAY ===
      updateNowPlaying() {
        if (!this.webamp || !this.webamp.store) return;
        
        try {
          const state = this.webamp.store.getState();
          const currentTrackId = state.media?.currentTrack;
          const tracks = state.tracks || {};
          
          if (currentTrackId && tracks[currentTrackId]) {
            const track = tracks[currentTrackId];
            this.currentTrack = track;
            
            const titleEl = document.getElementById('trackTitle');
            const artistEl = document.getElementById('trackArtist');
            const albumArt = document.getElementById('albumArt');
            const playPauseBtn = document.getElementById('playPauseBtn');
            
            if (titleEl) titleEl.textContent = track.defaultName || 'Unknown Track';
            if (artistEl) artistEl.textContent = track.metaData?.artist || 'Unknown Artist';
            
            if (albumArt) {
              albumArt.classList.toggle('playing', state.media?.status === 'PLAYING');
            }
            
            this.isPlaying = state.media?.status === 'PLAYING';
            if (playPauseBtn) {
              playPauseBtn.textContent = this.isPlaying ? '⏸' : '▶';
            }
            
            this.updateProgress();
            this.addToHistory(track);
            
            // Update track stats if visible
            if (this.isStatsVisible) {
              this.updateTrackStats();
            }
          } else {
            const titleEl = document.getElementById('trackTitle');
            const artistEl = document.getElementById('trackArtist');
            const albumArt = document.getElementById('albumArt');
            
            if (titleEl) titleEl.textContent = 'Winamp Ultimate Pro Max';
            if (artistEl) artistEl.textContent = 'Wybierz utwór aby rozpocząć';
            if (albumArt) albumArt.classList.remove('playing');
          }
        } catch (error) {
          console.error('Error updating now playing:', error);
        }
      }

      updateProgress() {
        if (!this.webamp || !this.webamp.store) return;
        
        try {
          const state = this.webamp.store.getState();
          const timeElapsed = state.media?.timeElapsed || 0;
          const length = state.media?.length || 1;
          
          const progress = (timeElapsed / length) * 100;
          const progressBar = document.getElementById('trackProgressBar');
          if (progressBar) {
            progressBar.style.width = `${progress}%`;
          }
          
          // Update track stats position if visible
          if (this.isStatsVisible) {
            this.updateTrackStats();
          }
        } catch (error) {
          console.error('Error updating progress:', error);
        }
      }

      // === ENHANCED PLAYBACK CONTROLS ===
      playPause() {
        this.debounceClick(() => {
          if (this.webamp && this.webamp.play && this.webamp.pause) {
            if (this.isPlaying) {
              this.webamp.pause();
            } else {
              this.webamp.play();
            }
          }
        });
      }

      nextTrack() {
        this.debounceClick(() => {
          if (this.webamp && this.webamp.nextTrack) {
            this.webamp.nextTrack();
            this.showToast('⏭ Next Track');
          }
        });
      }

      previousTrack() {
        this.debounceClick(() => {
          if (this.webamp && this.webamp.previousTrack) {
            this.webamp.previousTrack();
            this.showToast('⏮ Previous Track');
          }
        });
      }

      toggleShuffle() {
        this.debounceClick(() => {
          if (!this.webamp || !this.webamp.store) return;
          
          try {
            const state = this.webamp.store.getState();
            const isShuffled = state.playlist?.shuffle;
            
            this.webamp.store.dispatch({
              type: 'TOGGLE_SHUFFLE'
            });
            
            const btn = document.getElementById('shuffleBtn');
            if (btn) {
              btn.style.color = !isShuffled ? 'var(--accent-primary)' : 'var(--text-muted)';
            }
            
            this.showToast(!isShuffled ? '🔀 Shuffle ON' : '🔀 Shuffle OFF');
          } catch (error) {
            console.error('Error toggling shuffle:', error);
          }
        });
      }

      toggleRepeat() {
        this.debounceClick(() => {
          if (!this.webamp || !this.webamp.store) return;
          
          try {
            const state = this.webamp.store.getState();
            const isRepeating = state.playlist?.repeat;
            
            this.webamp.store.dispatch({
              type: 'TOGGLE_REPEAT'
            });
            
            const btn = document.getElementById('repeatBtn');
            if (btn) {
              btn.style.color = !isRepeating ? 'var(--accent-primary)' : 'var(--text-muted)';
            }
            
            this.showToast(!isRepeating ? '🔁 Repeat ON' : '🔁 Repeat OFF');
          } catch (error) {
            console.error('Error toggling repeat:', error);
          }
        });
      }

      // === PLAYLIST MANAGEMENT ===
      switchPlaylistTab(tab) {
        this.currentPlaylistTab = tab;
        
        // Update active tab buttons
        document.querySelectorAll('[onclick*="switchPlaylistTab"]').forEach(btn => {
          btn.style.background = 'rgba(157,78,221,0.1)';
          btn.style.color = 'var(--accent-purple)';
        });
        
        const activeBtn = document.querySelector(`[onclick*="switchPlaylistTab('${tab}')"]`);
        if (activeBtn) {
          activeBtn.style.background = 'var(--accent-purple)';
          activeBtn.style.color = 'var(--primary-bg)';
        }
        
        this.updatePlaylistDisplay();
      }

      updatePlaylistDisplay() {
        const list = document.getElementById('playlistList');
        if (!list) return;
        
        list.innerHTML = '';
        
        let items = [];
        
        switch (this.currentPlaylistTab) {
          case 'current':
            items = this.getCurrentPlaylist();
            break;
          case 'favorites':
            items = this.getFavoriteStations();
            break;
          case 'history':
            items = this.recentlyPlayed;
            break;
        }
        
        if (items.length === 0) {
          list.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
              <div style="font-size: 32px; margin-bottom: 15px;">📭</div>
              <div style="font-size: 14px;">Brak elementów</div>
            </div>
          `;
          return;
        }
        
        items.forEach((item, index) => {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'radio-station-item';
          itemDiv.style.cursor = 'pointer';
          itemDiv.style.marginBottom = '8px';
          
          // Prevent double-click issues
          let clickTimeout;
          itemDiv.onclick = () => {
            clearTimeout(clickTimeout);
            clickTimeout = setTimeout(() => {
              this.playPlaylistItem(item, index);
            }, 200);
          };
          
          itemDiv.innerHTML = `
            <div style="font-size: 13px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px; line-height: 1.3;">
              ${item.name || item.defaultName || 'Unknown'}
            </div>
            <div style="font-size: 11px; color: var(--text-muted);">
              ${item.metaData?.artist || item.country || 'Unknown'}
            </div>
          `;
          
          list.appendChild(itemDiv);
        });
      }

      getCurrentPlaylist() {
        if (!this.webamp || !this.webamp.store) return [];
        
        try {
          const state = this.webamp.store.getState();
          const playlist = state.playlist || {};
          const tracks = state.tracks || {};
          
          return Object.entries(playlist)
            .sort((a, b) => a[1] - b[1])
            .map(([id]) => tracks[id])
            .filter(Boolean);
        } catch (error) {
          console.error('Error getting current playlist:', error);
          return [];
        }
      }

      playPlaylistItem(item, index) {
        if (this.currentPlaylistTab === 'current' && this.webamp && this.webamp.store) {
          try {
            const state = this.webamp.store.getState();
            const playlist = state.playlist || {};
            const trackIds = Object.entries(playlist).sort((a, b) => a[1] - b[1]).map(e => e[0]);
            const trackId = trackIds[index];
            
            if (trackId) {
              this.webamp.store.dispatch({ type: 'PLAY_TRACK', trackId });
            }
          } catch (error) {
            console.error('Error playing playlist item:', error);
          }
        } else if (this.currentPlaylistTab === 'favorites') {
          this.addRadioStation(item);
        } else if (this.currentPlaylistTab === 'history') {
          this.addToCurrentPlaylist(item);
        }
        
        // Auto-close playlist on mobile
        if (this.isMobile) {
          setTimeout(() => this.togglePlaylist(), 1000);
        }
      }

      addToCurrentPlaylist(item) {
        if (this.webamp && this.webamp.appendTracks) {
          this.webamp.appendTracks([item]);
          this.showNotification(`✅ Dodano: ${item.name || item.defaultName}`, 'success');
        }
      }

      // === HISTORY MANAGEMENT ===
      loadHistory() {
        try {
          const stored = localStorage.getItem(this.HISTORY_KEY);
          if (stored) {
            this.recentlyPlayed = JSON.parse(stored);
          }
        } catch (e) {
          console.error('Failed to load history:', e);
          this.recentlyPlayed = [];
        }
      }

      saveHistory() {
        try {
          const trimmed = this.recentlyPlayed.slice(-50);
          localStorage.setItem(this.HISTORY_KEY, JSON.stringify(trimmed));
        } catch (e) {
          console.error('Failed to save history:', e);
        }
      }

      addToHistory(track) {
        if (!track) return;
        
        const historyItem = {
          name: track.defaultName || track.name,
          url: track.url,
          metaData: track.metaData,
          playedAt: Date.now()
        };
        
        this.recentlyPlayed = this.recentlyPlayed.filter(item => item.url !== track.url);
        this.recentlyPlayed.unshift(historyItem);
        
        this.saveHistory();
        
        if (this.currentPlaylistTab === 'history') {
          this.updatePlaylistDisplay();
        }
      }

      // === SIDEBAR CONTROLS ===
      toggleEqualizer() {
        const sidebar = document.getElementById('equalizerSidebar');
        const overlay = document.getElementById('equalizerOverlay');
        const btn = document.getElementById('equalizerBtn');
        
        if (!sidebar || !overlay) return;
        
        const isActive = sidebar.classList.contains('active');
        
        if (isActive) {
          sidebar.classList.remove('active');
          overlay.classList.remove('active');
          if (btn) btn.classList.remove('active');
        } else {
          // Close other sidebars first
          this.closeAllSidebars();
          
          sidebar.classList.add('active');
          overlay.classList.add('active');
          if (btn) btn.classList.add('active');
          
          // Setup overlay click handler
          overlay.onclick = () => this.toggleEqualizer();
        }
        
        this.saveSettings();
      }

      togglePlaylist() {
        const sidebar = document.getElementById('playlistSidebar');
        const overlay = document.getElementById('playlistOverlay');
        const btn = document.getElementById('playlistBtn');
        
        if (!sidebar || !overlay) return;
        
        const isActive = sidebar.classList.contains('active');
        
        if (isActive) {
          sidebar.classList.remove('active');
          overlay.classList.remove('active');
          if (btn) btn.classList.remove('active');
        } else {
          // Close other sidebars first
          this.closeAllSidebars();
          
          sidebar.classList.add('active');
          overlay.classList.add('active');
          if (btn) btn.classList.add('active');
          
          // Setup overlay click handler
          overlay.onclick = () => this.togglePlaylist();
          
          this.updatePlaylistDisplay();
        }
        
        this.saveSettings();
      }

      toggleRadio() {
        this.triggerHapticFeedback('light');
        
        const sidebar = document.getElementById('radioSidebar');
        const overlay = document.getElementById('radioOverlay');
        const btn = document.getElementById('radioBtn');
        
        if (!sidebar || !overlay) return;
        
        const isActive = sidebar.classList.contains('active');
        
        if (isActive) {
          sidebar.classList.remove('active');
          overlay.classList.remove('active');
          if (btn) btn.classList.remove('active');
        } else {
          // Close other sidebars first
          this.closeAllSidebars();
          
          sidebar.classList.add('active');
          overlay.classList.add('active');
          if (btn) btn.classList.add('active');
          
          // Setup overlay click handler
          overlay.onclick = () => this.toggleRadio();
          
          if (this.radioStations.length === 0) {
            setTimeout(() => this.loadRadioStations(), 300);
          }
        }
        
        this.saveSettings();
      }

      toggleThemes() {
        const sidebar = document.getElementById('themeSidebar');
        const overlay = document.getElementById('themesOverlay');
        const btn = document.getElementById('themesBtn');
        
        if (!sidebar || !overlay) return;
        
        const isActive = sidebar.classList.contains('active');
        
        if (isActive) {
          sidebar.classList.remove('active');
          overlay.classList.remove('active');
          if (btn) btn.classList.remove('active');
        } else {
          // Close other sidebars first
          this.closeAllSidebars();
          
          sidebar.classList.add('active');
          overlay.classList.add('active');
          if (btn) btn.classList.add('active');
          
          // Setup overlay click handler
          overlay.onclick = () => this.toggleThemes();
        }
        
        this.saveSettings();
      }

      closeAllSidebars() {
        const sidebars = ['radioSidebar', 'equalizerSidebar', 'playlistSidebar', 'themeSidebar'];
        const overlays = ['radioOverlay', 'equalizerOverlay', 'playlistOverlay', 'themesOverlay'];
        const buttons = ['radioBtn', 'equalizerBtn', 'playlistBtn', 'themesBtn'];
        
        sidebars.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.classList.remove('active');
        });
        
        overlays.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.classList.remove('active');
        });
        
        buttons.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.classList.remove('active');
        });
      }

      // === RADIO BROWSER API SERVICE ===
      initializeStations() {
        this.radioBrowserConfig = {
          servers: [
            'https://de1.api.radio-browser.info',
            'https://fi1.api.radio-browser.info', 
            'https://nl1.api.radio-browser.info',
            'https://at1.api.radio-browser.info'
          ],
          userAgent: 'Winamp Ultimate Pro Max/3.0',
          cacheDuration: 5 * 60 * 1000,
          maxRetries: 3,
          timeout: 10000
        };

        this.apiCache = new Map();
        this.currentServerIndex = 0;
        this.availableCountries = [];
        this.availableTags = [];
        this.availableLanguages = [];
      }

      async makeApiRequest(endpoint, params = {}) {
        const cacheKey = `${endpoint}?${new URLSearchParams(params).toString()}`;
        
        if (this.apiCache.has(cacheKey)) {
          const cached = this.apiCache.get(cacheKey);
          if (Date.now() - cached.timestamp < this.radioBrowserConfig.cacheDuration) {
            return cached.data;
          }
        }

        let lastError;
        
        for (let attempt = 0; attempt < this.radioBrowserConfig.servers.length; attempt++) {
          const serverIndex = (this.currentServerIndex + attempt) % this.radioBrowserConfig.servers.length;
          const baseUrl = this.radioBrowserConfig.servers[serverIndex];
          
          try {
            const url = new URL(endpoint, baseUrl);
            Object.entries(params).forEach(([key, value]) => {
              if (value !== undefined && value !== '') {
                url.searchParams.append(key, value);
              }
            });

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), this.radioBrowserConfig.timeout);

            const response = await fetch(url.toString(), {
              headers: {
                'User-Agent': this.radioBrowserConfig.userAgent,
                'Content-Type': 'application/json'
              },
              signal: controller.signal
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            
            this.apiCache.set(cacheKey, {
              data,
              timestamp: Date.now()
            });

            this.currentServerIndex = serverIndex;
            
            return data;

          } catch (error) {
            lastError = error;
            console.warn(`API request failed on server ${serverIndex}:`, error.message);
            continue;
          }
        }

        throw new Error(`All API servers failed. Last error: ${lastError?.message}`);
      }

      async searchStations(params = {}) {
        const defaultParams = {
          limit: 100,
          offset: 0,
          hidebroken: 'true',
          order: 'votes',
          reverse: 'true'
        };

        return await this.makeApiRequest('/json/stations/search', {
          ...defaultParams,
          ...params
        });
      }

      async getPopularStations(limit = 50, offset = 0) {
        return await this.makeApiRequest('/json/stations/topclick', {
          limit,
          offset,
          hidebroken: 'true'
        });
      }

      async getRecentStations(limit = 50, offset = 0) {
        return await this.makeApiRequest('/json/stations/lastchange', {
          limit,
          offset,
          hidebroken: 'true'
        });
      }

      async getTopStations(limit = 50, offset = 0) {
        return await this.makeApiRequest('/json/stations/topvote', {
          limit,
          offset,
          hidebroken: 'true'
        });
      }

      async getStationsByCountry(countryCode, limit = 100, offset = 0) {
        return await this.makeApiRequest('/json/stations/bycountrycode/' + countryCode, {
          limit,
          offset,
          hidebroken: 'true',
          order: 'votes',
          reverse: 'true'
        });
      }

      async getStationsByTag(tag, limit = 100, offset = 0) {
        return await this.makeApiRequest('/json/stations/bytag/' + encodeURIComponent(tag), {
          limit,
          offset,
          hidebroken: 'true',
          order: 'votes',
          reverse: 'true'
        });
      }

      async clickStation(stationUuid) {
        try {
          await this.makeApiRequest(`/json/url/${stationUuid}`);
        } catch (error) {
          console.warn('Failed to register station click:', error);
        }
      }

      // === STATION DATA TRANSFORMATION ===
      transformStation(apiStation) {
        return {
          id: apiStation.stationuuid,
          name: apiStation.name || 'Unknown Station',
          url: apiStation.url_resolved || apiStation.url,
          country: apiStation.country || 'Unknown',
          countryCode: apiStation.countrycode || '',
          city: apiStation.state || 'Unknown',
          genre: this.extractMainGenre(apiStation.tags),
          type: this.determineStationType(apiStation),
          description: this.generateDescription(apiStation),
          quality: this.formatBitrate(apiStation.bitrate),
          votes: apiStation.votes || 0,
          clickcount: apiStation.clickcount || 0,
          favicon: apiStation.favicon,
          homepage: apiStation.homepage,
          codec: apiStation.codec || 'Unknown',
          language: Array.isArray(apiStation.language) ? apiStation.language : [apiStation.language].filter(Boolean),
          tags: apiStation.tags ? apiStation.tags.split(',').map(t => t.trim()).filter(Boolean) : [],
          lastCheckOk: Boolean(apiStation.lastcheckok),
          lastCheckTime: apiStation.lastchecktime_iso8601,
          isLive: Boolean(apiStation.lastcheckok)
        };
      }

      extractMainGenre(tags) {
        if (!tags) return 'Radio';
        const tagList = tags.split(',').map(t => t.trim()).filter(Boolean);
        if (tagList.length === 0) return 'Radio';
        
        const commonGenres = ['pop', 'rock', 'jazz', 'classical', 'electronic', 'hip hop', 'country', 'r&b', 'alternative', 'indie'];
        const mainGenre = tagList.find(tag => 
          commonGenres.some(genre => tag.toLowerCase().includes(genre))
        );
        
        return mainGenre || tagList[0] || 'Radio';
      }

      determineStationType(station) {
        const codec = (station.codec || '').toLowerCase();
        const bitrate = station.bitrate || 0;
        
        if (bitrate >= 256) return 'premium';
        if (codec.includes('aac') || codec.includes('flac')) return 'premium';
        if (station.homepage && station.homepage.includes('bbc')) return 'dab';
        return 'internet';
      }

      generateDescription(station) {
        const parts = [];
        
        if (station.votes > 100) parts.push(`${station.votes} votes`);
        if (station.clickcount > 1000) parts.push(`${this.formatNumber(station.clickcount)} listeners`);
        if (station.codec) parts.push(station.codec);
        if (station.language && station.language.length > 0) {
          parts.push(Array.isArray(station.language) ? station.language.join(', ') : station.language);
        }
        
        return parts.length > 0 ? parts.join(' • ') : 'Internet radio station';
      }

      formatBitrate(bitrate) {
        if (!bitrate || bitrate === 0) return 'Unknown';
        return `${bitrate}k`;
      }

      formatNumber(num) {
        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
        return num.toString();
      }

      // === FAVORITES MANAGEMENT ===
      loadFavorites() {
        try {
          const stored = localStorage.getItem(this.FAVORITES_KEY);
          if (stored) {
            this.favorites = new Set(JSON.parse(stored));
          }
        } catch (e) {
          console.error('Failed to load favorites:', e);
          this.favorites = new Set();
        }
      }

      saveFavorites() {
        try {
          localStorage.setItem(this.FAVORITES_KEY, JSON.stringify([...this.favorites]));
        } catch (e) {
          console.error('Failed to save favorites:', e);
        }
      }

      toggleFavorite(stationId) {
        this.triggerHapticFeedback('light');
        
        if (this.favorites.has(stationId)) {
          this.favorites.delete(stationId);
          this.showNotification(`💔 Usunięto z ulubionych`, 'info');
        } else {
          this.favorites.add(stationId);
          this.showNotification(`💖 Dodano do ulubionych`, 'success');
          this.triggerHapticFeedback('success');
        }
        this.saveFavorites();
        this.displayRadioStations();
        
        if (this.currentPlaylistTab === 'favorites') {
          this.updatePlaylistDisplay();
        }
      }

      getFavoriteStations() {
        return this.radioStations.filter(station => this.favorites.has(station.id));
      }

      // === RADIO FUNCTIONALITY ===
      async loadRadioStations() {
        this.setLoading(true);
        const apiType = document.getElementById('radioCategorySelect')?.value || 'popular';
        
        try {
          this.showNotification('🔄 Ładowanie stacji z Radio Browser API...', 'info');
          
          let apiStations = [];
          
          switch (apiType) {
            case 'popular':
              apiStations = await this.getPopularStations(100);
              break;
            case 'recent':
              apiStations = await this.getRecentStations(100);
              break;
            case 'top':
              apiStations = await this.getTopStations(100);
              break;
            case 'poland':
              apiStations = await this.getStationsByCountry('PL', 100);
              break;
            case 'usa':
              apiStations = await this.getStationsByCountry('US', 100);
              break;
            case 'uk':
              apiStations = await this.getStationsByCountry('GB', 100);
              break;
            case 'germany':
              apiStations = await this.getStationsByCountry('DE', 100);
              break;
            case 'rock':
              apiStations = await this.getStationsByTag('rock', 100);
              break;
            case 'pop':
              apiStations = await this.getStationsByTag('pop', 100);
              break;
            case 'jazz':
              apiStations = await this.getStationsByTag('jazz', 100);
              break;
            case 'electronic':
              apiStations = await this.getStationsByTag('electronic', 100);
              break;
            case 'classical':
              apiStations = await this.getStationsByTag('classical', 100);
              break;
            case 'news':
              apiStations = await this.getStationsByTag('news', 100);
              break;
            case 'hifi':
              apiStations = await this.searchStations({
                limit: 100,
                bitrate: 192,
                order: 'bitrate',
                reverse: 'true'
              });
              break;
            case 'favorites':
              this.radioStations = this.getFavoriteStations();
              this.filteredStations = [...this.radioStations];
              this.displayRadioStations();
              this.updateRadioStats();
              this.showNotification(`✅ Załadowano ${this.radioStations.length} ulubionych stacji!`, 'success');
              this.setLoading(false);
              return;
            default:
              apiStations = await this.getPopularStations(100);
          }
          
          this.radioStations = apiStations.map(station => this.transformStation(station));
          this.filteredStations = [...this.radioStations];
          
          this.displayRadioStations();
          this.updateRadioStats();
          this.showNotification(`✅ Załadowano ${this.radioStations.length} stacji z Radio Browser!`, 'success');
          
        } catch (error) {
          console.error('Radio loading error:', error);
          this.showNotification('❌ Błąd ładowania stacji z API: ' + error.message, 'error');
          
          this.radioStations = await this.getDemoStations();
          this.filteredStations = [...this.radioStations];
          this.displayRadioStations();
          this.updateRadioStats();
          this.showNotification('⚠️ Załadowano demo stacje (API niedostępne)', 'warning');
        } finally {
          this.setLoading(false);
        }
      }

      async getDemoStations() {
        return [
          { id: 'demo1', name: "SoundHelix Demo 1", url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3", country: "Demo", countryCode: "XX", city: "Test", genre: "Demo", type: "internet", description: "Test stream zawsze działa", quality: "320k", votes: 0, isLive: true },
          { id: 'demo2', name: "SoundHelix Demo 2", url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3", country: "Demo", countryCode: "XX", city: "Test", genre: "Demo", type: "internet", description: "Test stream zawsze działa", quality: "320k", votes: 0, isLive: true },
          { id: 'soma1', name: "SomaFM Groove Salad", url: "http://ice1.somafm.com/groovesalad-256-mp3", country: "United States", countryCode: "US", city: "San Francisco", genre: "Chillout", type: "premium", description: "Ambient elektroniczna muzyka", quality: "256k", votes: 500, isLive: true }
        ];
      }

      async loadMoreStations() {
        if (this.isLoadingMore) return;
        
        this.isLoadingMore = true;
        const currentOffset = this.radioStations.length;
        const apiType = document.getElementById('radioCategorySelect')?.value || 'popular';
        
        if (apiType === 'favorites') {
          this.showToast('⚠️ Brak więcej ulubionych');
          this.isLoadingMore = false;
          return;
        }

        const loadMoreBtn = document.getElementById('radioLoadMore');
        const originalText = loadMoreBtn?.textContent || '';
        if (loadMoreBtn) {
          loadMoreBtn.textContent = '🔄 ŁADOWANIE...';
          loadMoreBtn.style.opacity = '0.7';
        }
        
        try {
          let newStations = [];
          
          switch (apiType) {
            case 'popular':
              newStations = await this.getPopularStations(30, currentOffset);
              break;
            case 'recent':
              newStations = await this.getRecentStations(30, currentOffset);
              break;
            case 'top':
              newStations = await this.getTopStations(30, currentOffset);
              break;
            case 'poland':
              newStations = await this.getStationsByCountry('PL', 30, currentOffset);
              break;
            case 'usa':
              newStations = await this.getStationsByCountry('US', 30, currentOffset);
              break;
            case 'uk':
              newStations = await this.getStationsByCountry('GB', 30, currentOffset);
              break;
            case 'germany':
              newStations = await this.getStationsByCountry('DE', 30, currentOffset);
              break;
            case 'rock':
              newStations = await this.getStationsByTag('rock', 30, currentOffset);
              break;
            case 'pop':
              newStations = await this.getStationsByTag('pop', 30, currentOffset);
              break;
            case 'jazz':
              newStations = await this.getStationsByTag('jazz', 30, currentOffset);
              break;
            case 'electronic':
              newStations = await this.getStationsByTag('electronic', 30, currentOffset);
              break;
            case 'classical':
              newStations = await this.getStationsByTag('classical', 30, currentOffset);
              break;
            case 'news':
              newStations = await this.getStationsByTag('news', 30, currentOffset);
              break;
            case 'hifi':
              newStations = await this.searchStations({
                limit: 30,
                bitrate: 192,
                order: 'bitrate',
                reverse: 'true',
                offset: Math.floor(currentOffset / 2)
              });
              break;
            default:
              newStations = await this.getPopularStations(30, currentOffset);
          }
          
          const existingIds = new Set(this.radioStations.map(s => s.id));
          const uniqueNewStations = newStations
            .map(station => this.transformStation(station))
            .filter(station => !existingIds.has(station.id));
          
          if (uniqueNewStations.length === 0) {
            this.showToast('📻 Koniec listy');
            return;
          }

          this.radioStations.push(...uniqueNewStations);
          this.filteredStations = [...this.radioStations];
          
          this.displayRadioStations();
          this.updateRadioStats();
          
          this.showToast(`+${uniqueNewStations.length} stacji`);
          
        } catch (error) {
          console.error('Error loading more stations:', error);
          this.showToast('❌ Błąd');
        } finally {
          if (loadMoreBtn) {
            loadMoreBtn.textContent = originalText;
            loadMoreBtn.style.opacity = '1';
          }
          this.isLoadingMore = false;
        }
      }

      async performAdvancedSearch(query) {
        if (!query.trim()) {
          await this.loadRadioStations();
          return;
        }

        this.setLoading(true);
        try {
          const results = await this.searchStations({
            name: query,
            limit: 100,
            hidebroken: 'true',
            order: 'votes',
            reverse: 'true'
          });

          this.radioStations = results.map(station => this.transformStation(station));
          this.filteredStations = [...this.radioStations];
          
          this.displayRadioStations();
          this.updateRadioStats();
          
          if (this.radioStations.length > 0) {
            this.showNotification(`🔍 Znaleziono ${this.radioStations.length} stacji dla: "${query}"`, 'success');
          } else {
            this.showNotification(`😢 Brak wyników dla: "${query}"`, 'warning');
          }
        } catch (error) {
          console.error('Search error:', error);
          this.showNotification('❌ Błąd wyszukiwania: ' + error.message, 'error');
        } finally {
          this.setLoading(false);
        }
      }

      displayRadioStations() {
        const list = document.getElementById('radioStationsList');
        if (!list) return;
        
        list.innerHTML = '';
        
        if (this.filteredStations.length === 0) {
          list.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
              <div style="font-size: 32px; margin-bottom: 15px;">📻</div>
              <div style="font-size: 14px; margin-bottom: 15px; color: var(--text-secondary);">Brak stacji</div>
              <button onclick="app?.loadRadioStations?.()" style="
                padding: 12px 20px; 
                background: rgba(0, 255, 65, 0.1); 
                border: 2px solid var(--accent-primary); 
                border-radius: 8px; 
                color: var(--accent-primary); 
                font-weight: 600; 
                cursor: pointer; 
                font-size: 12px;
                transition: all 0.3s ease;
                min-height: 44px;
              " onmouseover="this.style.background='var(--accent-primary)'; this.style.color='var(--primary-bg)'" onmouseout="this.style.background='rgba(0, 255, 65, 0.1)'; this.style.color='var(--accent-primary)'">
                🔄 ODŚWIEŻ
              </button>
            </div>
          `;
          return;
        }
        
        this.filteredStations.forEach((station, index) => {
          const stationDiv = document.createElement('div');
          stationDiv.className = `radio-station-item ${this.favorites.has(station.id) ? 'favorite' : ''} ${!station.isLive ? 'offline' : ''}`;
          
          const countryFlag = this.getCountryFlag(station.country);
          const isFavorite = this.favorites.has(station.id);
          const isHiFi = station.quality && parseInt(station.quality) >= 192;
          
          let cleanName = station.name.replace(/\s*-\s*(Radio|FM|Stream|Live)$/i, '');
          if (cleanName.length > 35) {
            cleanName = cleanName.substring(0, 32) + '...';
          }
          
          stationDiv.innerHTML = `
            <div class="radio-station-header">
              <div class="radio-station-name" title="${station.name}">${cleanName}</div>
              <div class="radio-station-controls">
                <button class="radio-play-btn" title="▶ Odtwórz">▶</button>
                <button class="radio-fav-btn ${isFavorite ? 'active' : ''}" title="${isFavorite ? 'Usuń z' : 'Dodaj do'} ulubionych">
                  ${isFavorite ? '★' : '☆'}
                </button>
              </div>
            </div>
            <div class="radio-station-info">
              <div class="radio-station-meta">
                <span class="radio-country-flag">${countryFlag}</span>
                <div class="radio-genre-tag">${station.genre.length > 8 ? station.genre.substring(0, 6) + '.' : station.genre}</div>
                ${station.quality ? `<div class="radio-quality-badge ${isHiFi ? 'hifi' : ''}">${station.quality}</div>` : ''}
              </div>
              <div class="radio-station-stats">
                ${station.votes > 0 ? `👍${this.formatNumber(station.votes)}` : ''}
                ${station.clickcount > 0 ? ` 👥${this.formatNumber(station.clickcount)}` : ''}
              </div>
            </div>
          `;
          
          // Improved click handlers with debouncing
          const playBtn = stationDiv.querySelector('.radio-play-btn');
          const favBtn = stationDiv.querySelector('.radio-fav-btn');
          
          let playClickTimeout;
          let favClickTimeout;
          
          playBtn.onclick = (e) => {
            e.stopPropagation();
            clearTimeout(playClickTimeout);
            playClickTimeout = setTimeout(() => {
              this.addRadioStation(station);
            }, 200);
          };
          
          favBtn.onclick = (e) => {
            e.stopPropagation();
            clearTimeout(favClickTimeout);
            favClickTimeout = setTimeout(() => {
              this.toggleFavorite(station.id);
            }, 200);
          };
          
          list.appendChild(stationDiv);
        });
      }

      async addRadioStation(station) {
        console.log('Adding station:', station.name, station.url);
        this.setLoading(true);
        this.triggerHapticFeedback('medium');
        
        try {
          if (station.id && !station.id.startsWith('demo')) {
            await this.clickStation(station.id);
          }

          const stationKey = station.id || station.url;
          const currentRetries = this.currentRetries.get(stationKey) || 0;
          
          if (currentRetries >= this.maxRetries) {
            this.showNotification(`❌ Stacja ${station.name} niedostępna (${this.maxRetries} prób)`, 'error');
            this.triggerHapticFeedback('error');
            this.setLoading(false);
            return;
          }

          await this.webamp.appendTracks([{
            url: station.url,
            defaultName: station.name,
            metaData: {
              artist: `${this.getTypeLabel(station.type)} • ${station.country} • ${station.quality || 'Unknown'}`,
              title: station.name,
              genre: station.genre,
              year: new Date().getFullYear().toString(),
              album: `Radio Browser • ${station.votes ? station.votes + ' votes' : 'Internet Radio'}`
            }
          }]);
          
          this.savePlaylist();
          this.showNotification(`✅ Dodano: ${station.name}`, 'success');
          this.triggerHapticFeedback('success');
          this.currentRetries.delete(stationKey);
          
          if (station.votes > 100) {
            setTimeout(() => {
              this.showToast(`🔥 Popularna stacja! ${station.votes} głosów`);
            }, 1000);
          }
          
          if (this.isMobile) {
            setTimeout(() => this.toggleRadio(), 2000);
          }
        } catch (error) {
          console.error('Error adding station:', error);
          this.triggerHapticFeedback('error');
          const stationKey = station.id || station.url;
          const newRetries = (this.currentRetries.get(stationKey) || 0) + 1;
          this.currentRetries.set(stationKey, newRetries);
          
          if (newRetries < this.maxRetries) {
            this.showNotification(`⚠️ Próba ${newRetries}/${this.maxRetries} dla ${station.name}`, 'warning');
            setTimeout(() => this.addRadioStation(station), 2000);
          } else {
            this.showNotification(`❌ Nie udało się dodać: ${station.name}`, 'error');
          }
        } finally {
          this.setLoading(false);
        }
      }

      // === UI HELPERS ===
      getTypeLabel(type) {
        const labels = {
          'dab': 'DAB+',
          'fm': 'FM',
          'internet': 'NET',
          'premium': 'HiFi'
        };
        return labels[type] || 'RADIO';
      }

      getCountryFlag(country) {
        const flags = {
          'Poland': '🇵🇱', 'United States': '🇺🇸', 'United Kingdom': '🇬🇧', 
          'Germany': '🇩🇪', 'France': '🇫🇷', 'Italy': '🇮🇹', 'Spain': '🇪🇸', 
          'Netherlands': '🇳🇱', 'Canada': '🇨🇦', 'Australia': '🇦🇺', 
          'Switzerland': '🇨🇭', 'Demo': '🎵'
        };
        return flags[country] || '🌐';
      }

      updateRadioStats() {
        const totalStations = this.radioStations.length;
        const filteredCount = this.filteredStations.length;
        const liveStations = this.radioStations.filter(s => s.isLive).length;
        
        const stationCount = document.getElementById('stationCount');
        const liveCount = document.getElementById('liveCount');
        const favCount = document.getElementById('favCount');
        
        if (stationCount) stationCount.textContent = filteredCount;
        if (liveCount) liveCount.textContent = liveStations;
        if (favCount) favCount.textContent = this.favorites.size;
      }

      filterStations() {
        const searchInput = document.getElementById('radioSearchInput');
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        
        if (searchTerm.length > 2) {
          clearTimeout(this.searchTimeout);
          this.searchTimeout = setTimeout(() => {
            this.performAdvancedSearch(searchTerm);
          }, 800);
          return;
        }
        
        this.filteredStations = this.radioStations.filter(station => {
          return !searchTerm || 
            station.name.toLowerCase().includes(searchTerm) ||
            station.country.toLowerCase().includes(searchTerm) ||
            station.city.toLowerCase().includes(searchTerm) ||
            station.genre.toLowerCase().includes(searchTerm) ||
            station.description.toLowerCase().includes(searchTerm) ||
            (station.quality && station.quality.toLowerCase().includes(searchTerm)) ||
            (station.tags && station.tags.some(tag => tag.toLowerCase().includes(searchTerm)));
        });
        
        this.displayRadioStations();
        this.updateRadioStats();
      }

      // === PARTY MODE ===
      togglePartyMode() {
        this.isPartyMode = !this.isPartyMode;
        const body = document.body;
        const indicator = document.getElementById('partyIndicator');
        const btn = document.getElementById('partyBtn');
        const equalizer = document.getElementById('equalizerViz');
        
        if (this.isPartyMode) {
          body.classList.add('party-mode');
          if (indicator) indicator.style.display = 'flex';
          if (btn) btn.classList.add('active');
          if (equalizer) equalizer.style.display = 'flex';
          this.startEqualizer();
          this.showNotification('🎉 PARTY MODE ACTIVATED! 🎉', 'success');
          
          document.querySelectorAll('.orb').forEach((orb, index) => {
            orb.style.animationDuration = '5s';
            orb.style.opacity = '0.6';
          });
        } else {
          body.classList.remove('party-mode');
          if (indicator) indicator.style.display = 'none';
          if (btn) btn.classList.remove('active');
          if (equalizer) equalizer.style.display = 'none';
          this.stopEqualizer();
          this.showNotification('😴 Party mode disabled', 'info');
          
          document.querySelectorAll('.orb').forEach((orb, index) => {
            orb.style.animationDuration = `${25 + index * 5}s`;
            orb.style.opacity = '0.3';
          });
        }
        
        this.saveSettings();
      }

      startEqualizer() {
        const equalizer = document.getElementById('equalizerViz');
        if (!equalizer) return;
        
        equalizer.innerHTML = '';
        
        for (let i = 0; i < 20; i++) {
          const bar = document.createElement('div');
          bar.className = 'eq-bar';
          equalizer.appendChild(bar);
        }
        
        this.animateEqualizer();
      }

      animateEqualizer() {
        if (!this.isPartyMode) return;
        
        const bars = document.querySelectorAll('.eq-bar');
        bars.forEach(bar => {
          const height = Math.random() * 60 + 10;
          bar.style.height = `${height}px`;
        });
        
        requestAnimationFrame(() => this.animateEqualizer());
      }

      stopEqualizer() {
        const bars = document.querySelectorAll('.eq-bar');
        bars.forEach(bar => {
          bar.style.height = '5px';
        });
      }

      // === NOTIFICATION SYSTEM ===
      showNotification(message, type = 'info', duration = 4000) {
        const notification = document.getElementById('notification');
        if (!notification) return;
        
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.classList.add('show');
        
        setTimeout(() => {
          notification.classList.remove('show');
        }, duration);
      }

      showToast(message, duration = 3000) {
        const container = document.getElementById('toastContainer');
        if (!container) return;
        
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        
        container.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 100);
        
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => {
            if (container.contains(toast)) {
              container.removeChild(toast);
            }
          }, 400);
        }, duration);
      }

      // === UTILITY METHODS ===
      setLoading(isLoading) {
        const loading = document.getElementById('loading');
        if (!loading) return;
        
        if (isLoading) {
          loading.classList.add('active');
        } else {
          loading.classList.remove('active');
        }
      }

      // === SETTINGS PERSISTENCE ===
      saveSettings() {
        try {
          const settings = {
            radioVisible: document.getElementById('radioSidebar')?.classList.contains('active') || false,
            equalizerVisible: document.getElementById('equalizerSidebar')?.classList.contains('active') || false,
            playlistVisible: document.getElementById('playlistSidebar')?.classList.contains('active') || false,
            themesVisible: document.getElementById('themeSidebar')?.classList.contains('active') || false,
            debugVisible: document.getElementById('info')?.style.display === 'block',
            partyMode: this.isPartyMode,
            theme: this.currentTheme,
            apiType: document.getElementById('radioCategorySelect')?.value || 'popular',
            statsVisible: this.isStatsVisible,
            lastSaved: Date.now()
          };
          localStorage.setItem(this.STORAGE_KEY, JSON.stringify(settings));
        } catch (e) {
          console.error('Failed to save settings:', e);
        }
      }

      async restoreSettings() {
        try {
          const settings = JSON.parse(localStorage.getItem(this.STORAGE_KEY) || '{}');
          
          if (settings.theme) {
            this.setTheme(settings.theme);
          }
          
          if (settings.apiType) {
            const select = document.getElementById('radioCategorySelect');
            if (select) select.value = settings.apiType;
          }
          
          if (settings.statsVisible !== undefined) {
            this.isStatsVisible = settings.statsVisible;
            const content = document.getElementById('trackStatsContent');
            const btn = document.getElementById('statsToggle');
            if (content && this.isStatsVisible) {
              content.classList.add('show');
            }
            if (btn) {
              btn.style.color = this.isStatsVisible ? 'var(--accent-primary)' : 'var(--text-muted)';
            }
          }
          
        } catch (e) {
          console.error('Failed to restore settings:', e);
        }
      }

      // === PLAYLIST MANAGEMENT ===
      savePlaylist() {
        try {
          if (!this.webamp || !this.webamp.store) return;
          
          const state = this.webamp.store.getState();
          const playlist = state.playlist || {};
          const tracks = state.tracks || {};
          const savedTracks = Object.entries(playlist).map(([id, order]) => {
            const track = tracks[id];
            return track ? {
              url: track.url,
              defaultName: track.defaultName,
              metaData: track.metaData
            } : null;
          }).filter(Boolean);
          
          const currentTrackId = state.media?.currentTrack;
          let currentIndex = -1;
          if (currentTrackId) {
            currentIndex = playlist[currentTrackId];
          }
          
          localStorage.setItem('winamp_pro_max_playlist', JSON.stringify({ 
            tracks: savedTracks, 
            currentIndex,
            lastSaved: Date.now()
          }));
        } catch (e) {
          console.error('Failed to save playlist:', e);
        }
      }

      loadPlaylist() {
        try {
          const saved = localStorage.getItem('winamp_pro_max_playlist');
          if (saved) {
            const data = JSON.parse(saved);
            if (data.tracks && data.tracks.length > 0) {
              return data;
            }
          }
        } catch (e) {
          console.error('Failed to load playlist:', e);
        }
        return null;
      }

      // === DEBUG CONSOLE ===
      showDebug() {
        const info = document.getElementById('info');
        const btn = document.getElementById('debugBtn');
        
        if (!info) return;
        
        if (info.style.display === 'none' || !info.style.display) {
          if (!this.webamp || !this.webamp.store) {
            info.innerHTML = '<div style="color: var(--accent-secondary);">⚠️ Webamp nie jest jeszcze gotowy</div>';
            info.style.display = 'block';
            return;
          }
          
          const state = this.webamp.store.getState();
          const playlist = state.playlist || {};
          const tracks = state.tracks || {};
          const trackCount = Object.keys(playlist).length;
          
          let html = `<div style="color: var(--accent-primary); font-weight: 800;">🐛 Winamp Ultimate Pro Max - Debug Console v3.0</div>`;
          html += `<div style="color: var(--text-muted);">=============================================</div>`;
          html += `<div><span style="color: var(--accent-secondary);">📊 Tracks in playlist:</span> <strong>${trackCount}</strong></div>`;
          html += `<div><span style="color: var(--accent-secondary);">🎵 Current track:</span> ${state.media?.currentTrack || 'none'}</div>`;
          html += `<div><span style="color: var(--accent-secondary);">▶️ Status:</span> ${state.media?.status || 'unknown'}</div>`;
          html += `<div><span style="color: var(--accent-secondary);">🔊 Volume:</span> ${Math.round((state.media?.volume || 0) * 100)}%</div>`;
          html += `<div><span style="color: var(--accent-secondary);">🔀 Shuffle:</span> ${state.playlist?.shuffle ? '<span style="color: var(--accent-primary);">ON</span>' : '<span style="color: var(--text-muted);">OFF</span>'}</div>`;
          html += `<div><span style="color: var(--accent-secondary);">🔁 Repeat:</span> ${state.playlist?.repeat ? '<span style="color: var(--accent-primary);">ON</span>' : '<span style="color: var(--text-muted);">OFF</span>'}</div>`;
          html += `<div><span style="color: var(--accent-secondary);">📻 Radio stations loaded:</span> <strong>${this.radioStations.length}</strong></div>`;
          html += `<div><span style="color: var(--accent-secondary);">🔍 Filtered stations:</span> <strong>${this.filteredStations.length}</strong></div>`;
          html += `<div><span style="color: var(--accent-secondary);">💖 Favorites:</span> <strong>${this.favorites.size}</strong></div>`;
          html += `<div><span style="color: var(--accent-secondary);">📜 History items:</span> <strong>${this.recentlyPlayed.length}</strong></div>`;
          html += `<div><span style="color: var(--accent-secondary);">🎉 Party mode:</span> ${this.isPartyMode ? '<span style="color: var(--accent-primary);">ACTIVE</span>' : '<span style="color: var(--text-muted);">OFF</span>'}</div>`;
          html += `<div><span style="color: var(--accent-secondary);">🎨 Current theme:</span> ${this.currentTheme}</div>`;
          html += `<div><span style="color: var(--accent-secondary);">📊 Track Stats:</span> ${this.isStatsVisible ? '<span style="color: var(--accent-primary);">VISIBLE</span>' : '<span style="color: var(--text-muted);">HIDDEN</span>'}</div>`;
          html += `<div><span style="color: var(--accent-secondary);">🎛️ Audio Context:</span> ${this.audioContext ? '<span style="color: var(--accent-primary);">READY</span>' : '<span style="color: var(--accent-secondary);">NOT READY</span>'}</div>`;
          html += `<div><span style="color: var(--accent-secondary);">📱 Is Mobile:</span> ${this.isMobile ? '<span style="color: var(--accent-primary);">YES</span>' : '<span style="color: var(--text-muted);">NO</span>'}</div>`;
          html += `<div><span style="color: var(--accent-secondary);">📡 Current category:</span> ${document.getElementById('radioCategorySelect')?.value || 'unknown'}</div>`;
          html += `<div><span style="color: var(--accent-secondary);">💾 Storage used:</span> ${(JSON.stringify(localStorage).length / 1024).toFixed(2)} KB</div>`;
          html += `<div><span style="color: var(--accent-secondary);">🌐 User Agent:</span> ${navigator.userAgent.substring(0, 60)}...</div>`;
          html += `<div><span style="color: var(--accent-secondary);">📱 Screen:</span> ${window.innerWidth}x${window.innerHeight}</div>`;
          html += `<div><span style="color: var(--accent-secondary);">🎨 Webamp version:</span> ${typeof Webamp !== 'undefined' ? '<span style="color: var(--accent-primary);">Loaded</span>' : '<span style="color: var(--accent-secondary);">Not loaded</span>'}</div>`;
          html += `<div><span style="color: var(--accent-secondary);">🔄 Retries:</span> ${this.currentRetries.size} stations with retry attempts</div>`;
          
          info.innerHTML = html;
          info.style.display = 'block';
          if (btn) btn.classList.add('active');
          this.showNotification('🐛 Console debugowania otwarty', 'info');
        } else {
          info.style.display = 'none';
          if (btn) btn.classList.remove('active');
        }
        
        this.saveSettings();
      }

      clearAll() {
        if (confirm('Wyczyścić całą playlistę?')) {
          this.setLoading(true);
          
          try {
            if (this.webamp && this.webamp.store) {
              const state = this.webamp.store.getState();
              const trackIds = Object.keys(state.playlist || {});
              
              if (trackIds.length > 0) {
                this.webamp.store.dispatch({
                  type: 'REMOVE_TRACKS',
                  ids: trackIds
                });
                
                trackIds.forEach(id => {
                  try {
                    this.webamp.store.dispatch({
                      type: 'REMOVE_TRACK',
                      id: id
                    });
                  } catch (e) {
                    console.warn('Failed to remove track:', id);
                  }
                });
                
                this.webamp.store.dispatch({
                  type: 'SET_PLAYLIST',
                  playlist: {}
                });
                
                this.webamp.store.dispatch({
                  type: 'SET_TRACKS',
                  tracks: {}
                });
              }
            }
            
            localStorage.removeItem('winamp_pro_max_playlist');
            this.showNotification('🗑️ Playlista wyczyszczona', 'success');
            
            this.updateNowPlaying();
            this.updatePlaylistDisplay();
            
            setTimeout(() => {
              if (this.webamp && this.webamp.store) {
                this.webamp.store.dispatch({ type: 'UPDATE_TIME_ELAPSED', timeElapsed: 0 });
              }
            }, 100);
            
          } catch (error) {
            console.error('Error clearing playlist:', error);
            this.showNotification('❌ Błąd czyszczenia playlisty: ' + error.message, 'error');
            
            setTimeout(() => {
              location.reload();
            }, 2000);
          } finally {
            this.setLoading(false);
          }
        }
      }

      testPlaylist() {
        console.log('Adding test tracks...');
        this.setLoading(true);
        
        const testTracks = [
          {
            url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3',
            defaultName: 'Test Song 1',
            metaData: { artist: 'SoundHelix', title: 'Song 1', genre: 'Demo', year: '2024' }
          },
          {
            url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3',
            defaultName: 'Test Song 2', 
            metaData: { artist: 'SoundHelix', title: 'Song 2', genre: 'Demo', year: '2024' }
          },
          {
            url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3',
            defaultName: 'Test Song 3', 
            metaData: { artist: 'SoundHelix', title: 'Song 3', genre: 'Demo', year: '2024' }
          }
        ];
        
        try {
          if (this.webamp && this.webamp.appendTracks) {
            this.webamp.appendTracks(testTracks);
            this.savePlaylist();
            this.showNotification('🧪 Dodano testowe utwory', 'success');
          }
        } catch (error) {
          console.error('Error adding test tracks:', error);
          this.showNotification('❌ Błąd dodawania testowych utworów', 'error');
        } finally {
          this.setLoading(false);
        }
      }
    }

    // === GLOBAL APP INSTANCE ===
    let app;

    // === GLOBAL FUNCTIONS FOR INLINE EVENT HANDLERS ===
    function openFiles() {
      document.getElementById('fileInput')?.click();
    }

    function openFolder() {
      document.getElementById('folderInput')?.click();
    }

    function toggleThemes() {
      app?.toggleThemes?.();
    }

    function toggleRadio() {
      app?.toggleRadio?.();
    }

    function toggleEqualizer() {
      app?.toggleEqualizer?.();
    }

    function togglePlaylist() {
      app?.togglePlaylist?.();
    }

    function togglePartyMode() {
      app?.togglePartyMode?.();
    }

    function clearAll() {
      app?.clearAll?.();
    }

    function testPlaylist() {
      app?.testPlaylist?.();
    }

    function showDebug() {
      app?.showDebug?.();
    }

    function loadMoreStations() {
      app?.loadMoreStations?.();
    }

    function installPWA() {
      if (app?.deferredPrompt) {
        app.deferredPrompt.prompt();
        app.deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            app.showNotification('🎉 Aplikacja zainstalowana!', 'success');
          }
          app.deferredPrompt = null;
          const installBtn = document.getElementById('installBtn');
          if (installBtn) installBtn.style.display = 'none';
        });
      }
    }

    // === INITIALIZATION ===
    window.addEventListener('load', async () => {
      console.log('Initializing Winamp Ultimate Pro Max...');
      
      app = new WinampApp();
      app.setLoading(true);
      
      try {
        app.webamp = new Webamp({
          initialTracks: app.loadPlaylist()?.tracks || [],
          __butterchurnOptions: {
            importButterchurn: () => import('https://unpkg.com/butterchurn@2.6.7/lib/butterchurn.min.js'),
            importButterchurnPresets: () => import('https://unpkg.com/butterchurn-presets@2.4.7/lib/butterchurnPresets.min.js'),
          },
        });

        await app.webamp.renderWhenReady(document.getElementById('app'));
        console.log('Webamp rendered successfully');
        
        setupFileHandlers(app);
        setupRadioFilters(app);
        setupKeyboardShortcuts(app);
        await app.restoreSettings();
        
        app.webamp.store.subscribe(() => {
          app.savePlaylist();
          app.saveSettings();
          app.updateNowPlaying();
          app.updateProgress();
          app.updatePlaylistDisplay();
        });

        app.showNotification('🎵 Winamp Ultimate Pro Max gotowy! Użyj swipe gestures na mobile!', 'success');

      } catch (error) {
        console.error('Failed to initialize:', error);
        app.showNotification('❌ Błąd inicjalizacji: ' + error.message, 'error', 6000);
      } finally {
        app.setLoading(false);
      }
    });

    // === SETUP FUNCTIONS ===
    function setupFileHandlers(app) {
      const fileInput = document.getElementById('fileInput');
      const folderInput = document.getElementById('folderInput');
      const skinInput = document.getElementById('skinInput');
      
      if (fileInput) {
        fileInput.addEventListener('change', (e) => handleFiles(e, app));
      }
      if (folderInput) {
        folderInput.addEventListener('change', (e) => handleFiles(e, app));
      }
      if (skinInput) {
        skinInput.addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if (file) {
            try {
              app.setLoading(true);
              const url = URL.createObjectURL(file);
              await app.webamp.setSkin({ url });
              app.saveSettings();
              app.showNotification('🎨 Skórka załadowana!', 'success');
            } catch (error) {
              console.error('Skin error:', error);
              app.showNotification('❌ Błąd ładowania skórki', 'error');
            } finally {
              app.setLoading(false);
            }
          }
        });
      }

      let dragCounter = 0;
      
      document.addEventListener('dragenter', (e) => {
        e.preventDefault();
        dragCounter++;
        document.body.style.background = 'rgba(0, 255, 65, 0.1)';
      });
      
      document.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dragCounter--;
        if (dragCounter === 0) {
          document.body.style.background = '';
        }
      });
      
      document.addEventListener('dragover', e => e.preventDefault());
      
      document.addEventListener('drop', (e) => {
        e.preventDefault();
        dragCounter = 0;
        document.body.style.background = '';
        const files = [...e.dataTransfer.files];
        processFiles(files, app);
      });
    }

    function setupRadioFilters(app) {
      const searchInput = document.getElementById('radioSearchInput');
      const categorySelect = document.getElementById('radioCategorySelect');
      
      if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', () => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => app.filterStations(), 400);
        });
      }
      
      if (categorySelect) {
        categorySelect.addEventListener('change', async () => {
          await app.loadRadioStations();
        });
      }

      const apiStatus = document.getElementById('apiStatus');
      if (apiStatus) {
        app.makeApiRequest('/json/stats')
          .then(() => {
            apiStatus.textContent = '📡 Radio Browser API ✓';
            apiStatus.className = 'api-status online';
          })
          .catch(() => {
            apiStatus.textContent = '📡 API Offline';
            apiStatus.className = 'api-status offline';
          });
      }
    }

    function setupKeyboardShortcuts(app) {
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey || e.metaKey) {
          switch(e.key) {
            case 'o': case 'O':
              e.preventDefault();
              openFiles();
              break;
            case ' ':
              e.preventDefault();
              app.playPause();
              break;
            case 'ArrowLeft':
              e.preventDefault();
              app.previousTrack();
              break;
            case 'ArrowRight':
              e.preventDefault();
              app.nextTrack();
              break;
            case 'r': case 'R':
              e.preventDefault();
              app.toggleRadio();
              break;
            case 'e': case 'E':
              e.preventDefault();
              app.toggleEqualizer();
              break;
            case 'l': case 'L':
              e.preventDefault();
              app.togglePlaylist();
              break;
            case 't': case 'T':
              e.preventDefault();
              app.toggleThemes();
              break;
            case 'p': case 'P':
              e.preventDefault();
              app.togglePartyMode();
              break;
            case 's': case 'S':
              e.preventDefault();
              app.toggleShuffle();
              break;
            case '1':
              e.preventDefault();
              app.setTheme('default');
              break;
            case '2':
              e.preventDefault();
              app.setTheme('retro');
              break;
            case '3':
              e.preventDefault();
              app.setTheme('neon');
              break;
            case '4':
              e.preventDefault();
              app.setTheme('ocean');
              break;
            case '5':
              e.preventDefault();
              app.setTheme('sunset');
              break;
            case '6':
              e.preventDefault();
              app.setTheme('cyber');
              break;
          }
        }
        
        switch(e.key) {
          case 'F1':
            e.preventDefault();
            showHelpDialog();
            break;
          case 'F2':
            e.preventDefault();
            app.toggleStats();
            break;
          case 'F3':
            e.preventDefault();
            const searchInput = document.getElementById('radioSearchInput');
            if (searchInput) searchInput.focus();
            break;
        }
      });
    }

    function showHelpDialog() {
      const helpText = `
🎹 SKRÓTY KLAWISZOWE:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

PLAYBACK:
Ctrl + Space - Play/Pause
Ctrl + ← - Poprzedni utwór
Ctrl + → - Następny utwór
Ctrl + S - Shuffle

INTERFEJS:
Ctrl + O - Otwórz pliki
Ctrl + R - Radio sidebar
Ctrl + E - Equalizer sidebar
Ctrl + L - Playlist sidebar
Ctrl + T - Themes sidebar
Ctrl + P - Party mode

THEMES:
Ctrl + 1-6 - Szybka zmiana tematu

FUNKCJE:
F1 - Ta pomoc
F2 - Track Stats
F3 - Szukaj radia

MOBILE GESTURES:
Swipe ← → - Poprzedni/Następny
Swipe ↑ ↓ - Radio/Playlist

🎵 WINAMP ULTIMATE PRO MAX 🎵
      `;
      
      if (app) {
        app.showNotification(helpText, 'info', 10000);
      }
    }

    function handleFiles(e, app) {
      const files = [...e.target.files];
      processFiles(files, app);
      e.target.value = '';
    }

    function processFiles(files, app) {
      console.log('Processing files:', files);
      app.setLoading(true);
      
      const audioFiles = files.filter(f => {
        const name = f.name.toLowerCase();
        return name.match(/\.(mp3|wav|ogg|m4a|flac|aac|opus|webm)$/);
      });

      if (audioFiles.length === 0) {
        app.showNotification('⚠️ Nie znaleziono plików audio', 'warning');
        app.setLoading(false);
        return;
      }

      try {
        if (app.webamp && app.webamp.appendTracksFromFiles) {
          app.webamp.appendTracksFromFiles(audioFiles);
          app.showNotification(`✅ Dodano ${audioFiles.length} plików`, 'success');
        } else if (app.webamp && app.webamp.appendTracks) {
          const tracks = audioFiles.map(file => {
            const url = URL.createObjectURL(file);
            return {
              url: url,
              defaultName: file.name,
              metaData: {
                artist: '',
                title: file.name.replace(/\.[^/.]+$/, ''),
                genre: 'Local File',
                year: new Date().getFullYear().toString()
              }
            };
          });

          app.webamp.appendTracks(tracks);
          app.showNotification(`✅ Dodano ${tracks.length} utworów`, 'success');
        }
        
        app.savePlaylist();
      } catch (error) {
        console.error('Error processing files:', error);
        app.showNotification('❌ Błąd przetwarzania plików', 'error');
      } finally {
        app.setLoading(false);
      }
    }

    // === PWA INSTALLATION ===
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      if (app) {
        app.deferredPrompt = e;
        const installBtn = document.getElementById('installBtn');
        if (installBtn) installBtn.style.display = 'block';
      }
    });

    // === ERROR HANDLING ===
    window.addEventListener('error', (e) => {
      console.error('Global error:', e);
      if (app) {
        app.showNotification('❌ Błąd aplikacji: ' + e.message, 'error');
      }
    });

    window.addEventListener('unhandledrejection', (e) => {
      console.error('Unhandled promise rejection:', e);
      if (app) {
        app.showNotification('❌ Błąd: ' + e.reason, 'error');
      }
    });

    // === PERFORMANCE MONITORING ===
    window.addEventListener('load', () => {
      if ('performance' in window) {
        const perfData = performance.getEntriesByType('navigation')[0];
        console.log(`🚀 Winamp Ultimate Pro Max loaded in ${perfData.loadEventEnd - perfData.fetchStart}ms`);
      }
    });

    // === SERVICE WORKER REGISTRATION ===
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        const swCode = `
          const CACHE_NAME = 'winamp-ultimate-pro-max-v3';
          const urlsToCache = [
            '/',
            'https://unpkg.com/webamp@1.5.0/built/webamp.bundle.min.js'
          ];

          self.addEventListener('install', event => {
            event.waitUntil(
              caches.open(CACHE_NAME)
                .then(cache => cache.addAll(urlsToCache))
            );
          });

          self.addEventListener('fetch', event => {
            event.respondWith(
              caches.match(event.request)
                .then(response => {
                  if (response) {
                    return response;
                  }
                  return fetch(event.request);
                })
            );
          });
        `;

        const blob = new Blob([swCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);

        navigator.serviceWorker.register(swUrl)
          .then(registration => {
            console.log('🔧 Service Worker registered:', registration);
          })
          .catch(error => {
            console.log('❌ Service Worker registration failed:', error);
          });
      });
    }

    // === ADVANCED FEATURES ===
    setInterval(() => {
      if (app && app.webamp) {
        app.savePlaylist();
        app.saveSettings();
      }
    }, 30000);

    if ('serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
      navigator.serviceWorker.ready.then(registration => {
        return registration.sync.register('background-sync');
      }).catch(err => {
        console.log('Background sync registration failed:', err);
      });
    }

    window.addEventListener('beforeunload', () => {
      if (app) {
        app.savePlaylist();
        app.saveSettings();
        app.saveHistory();
        
        const state = app.webamp?.store?.getState();
        if (state?.tracks) {
          Object.values(state.tracks).forEach(track => {
            if (track.url && track.url.startsWith('blob:')) {
              URL.revokeObjectURL(track.url);
            }
          });
        }
      }
    });

    // Enhanced mobile support
    if (app?.isMobile) {
      document.addEventListener('touchstart', () => {}, { passive: true });
      
      let lastTouchEnd = 0;
      document.addEventListener('touchend', (e) => {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
          e.preventDefault();
        }
        lastTouchEnd = now;
      }, false);

      if ('mediaSession' in navigator) {
        navigator.mediaSession.setActionHandler('play', () => {
          if (app) app.playPause();
        });
        
        navigator.mediaSession.setActionHandler('pause', () => {
          if (app) app.playPause();
        });
        
        navigator.mediaSession.setActionHandler('previoustrack', () => {
          if (app) app.previousTrack();
        });
        
        navigator.mediaSession.setActionHandler('nexttrack', () => {
          if (app) app.nextTrack();
        });
      }
    }

    window.addEventListener('online', () => {
      if (app) {
        app.showNotification('🌐 Połączenie przywrócone', 'success');
        if (app.currentRetries.size > 0) {
          app.showToast('🔄 Wznawianie przerowanych stacji...');
        }
      }
    });

    window.addEventListener('offline', () => {
      if (app) {
        app.showNotification('📵 Tryb offline - radia mogą nie działać', 'warning', 6000);
      }
    });

    console.log(`
╔══════════════════════════════════════════════════════════╗
║           🎵 WINAMP ULTIMATE PRO MAX v3.0 🎵            ║
║                The Ultimate Music Experience             ║
║                                                          ║
║  ⭐ MOBILE-OPTIMIZED FEATURES:                           ║
║  • Fixed Touch/Click Conflicts ✅                       ║
║  • Improved Swipe Gestures ✅                           ║
║  • Larger Touch Targets (44px minimum) ✅               ║
║  • Debounced Click Handlers ✅                          ║
║  • Better Mobile Sidebar UX ✅                          ║
║  • Auto-close Sidebars on Mobile ✅                     ║
║  • Responsive Design Improvements ✅                    ║
║  • Enhanced Mobile Controls ✅                          ║
║  • Real-time Track Statistics ✅                        ║
║  • Better Performance (removed spectrum) ✅             ║
║  • Hidden Theme Panel (now sidebar) ✅                  ║
║  • Prevented Double-tap Zoom ✅                         ║
║                                                          ║
║  🎹 KEYBOARD SHORTCUTS:                                  ║
║  F1 - Help | F2 - Track Stats | F3 - Search Radio      ║
║  Ctrl+Space - Play/Pause | Ctrl+R - Radio              ║
║  Ctrl+E - Equalizer | Ctrl+L - Playlist                ║
║  Ctrl+T - Themes | Ctrl+P - Party Mode                 ║
║  Ctrl+1-6 - Quick Themes | Swipe gestures on mobile    ║
║                                                          ║
║  🌐 API: radio-browser.info                             ║
║  🎨 Themes: Cyber, Retro, Neon, Ocean, Sunset          ║
╚══════════════════════════════════════════════════════════╝
    `);

    console.log('🎵 Winamp Ultimate Pro Max - Mobile Fixed & Fully Loaded! 🚀');
  </script>
</body>
</html>
